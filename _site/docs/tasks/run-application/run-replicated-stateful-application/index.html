
  
    
    

  

  
    
    

  

  
    
    

  

  
    

<!Doctype html>
<html id="docs" class="Tasks">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" type="text/css" href="/css/styles.css"><!-- default styles.css on -->
    <link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
    <link rel="stylesheet" type="text/css" href="/css/callouts.css">
    <link rel="stylesheet" type="text/css" href="/css/custom-jekyll/tags.css">
    
    
    <!-- no custom css detected -->

    
    <meta name="description" content="Run a Replicated Stateful Application" />
    

    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/sweetalert.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/custom-jekyll/tags.js"></script>
    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Run a Replicated Stateful Application | Kubernetes</title>
<meta property="og:title" content="Run a Replicated Stateful Application" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Production-Grade Container Orchestration" />
<meta property="og:description" content="Production-Grade Container Orchestration" />
<link rel="canonical" href="http://0.0.0.0:4000/docs/tasks/run-application/run-replicated-stateful-application/" />
<meta property="og:url" content="http://0.0.0.0:4000/docs/tasks/run-application/run-replicated-stateful-application/" />
<meta property="og:site_name" content="Kubernetes" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@kubernetesio" />
<script type="application/ld+json">
{"name":null,"description":"Production-Grade Container Orchestration","author":null,"@type":"WebPage","url":"http://0.0.0.0:4000/docs/tasks/run-application/run-replicated-stateful-application/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/images/favicon.png"}},"image":null,"headline":"Run a Replicated Stateful Application","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>

<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/" class="logo"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            <li><a href="/docs/home/">Documentation</a></li>
            <li><a href="http://blog.kubernetes.io/">Blog</a></li>
            <li><a href="/partners/">Partners</a></li>
            <li><a href="/community/">Community</a></li>
            <li><a href="/case-studies/">Case Studies</a></li>
            <li>
                <a href="#">
                    v1.8 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                  <li><a href="https://kubernetes.io/docs/home/">v1.8</a></li>
                
                  <li><a href="https://v1-7.docs.kubernetes.io/docs/home/">v1.7</a></li>
                
                  <li><a href="https://v1-6.docs.kubernetes.io/docs/home/">v1.6</a></li>
                
                  <li><a href="https://v1-5.docs.kubernetes.io/docs/">v1.5</a></li>
                
                  <li><a href="https://v1-4.docs.kubernetes.io/docs/">v1.4</a></li>
                
                </ul>
              </li>
            </li>
        </ul>
        <!-- <a href="/docs/home" class="button" id="viewDocs" data-auto-burger-exclude>View Documentation</a> -->
        <a href="/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>Try Kubernetes</a>
        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <main data-auto-burger="primary">
        <div class="nav-box">
            <h3><a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a></h3>
            <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>
        </div>
        <div class="nav-box">
            <h3><a href="/docs/home/">Documentation</a></h3>
            <p>Learn how to use Kubernetes with the use of walkthroughs, samples, and reference documentation. You can even <a href="/editdocs/" data-auto-burger-exclude>help contribute to the docs</a>!</p>
        </div>
        <div class="nav-box">
            <h3><a href="/community/">Community</a></h3>
            <p>If you need help, you can connect with other Kubernetes users and the Kubernetes authors, attend community events, and watch video presentations from around the web.</p>
        </div>
        <div class="nav-box">
            <h3><a href="http://blog.kubernetes.io">Blog</a></h3>
            <p>Read the latest news for Kubernetes and the containers space in general, and get technical how-tos hot off the presses.</p>
        </div>
        </main>
        <main data-auto-burger="primary">
        <div class="left">
            <h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
            <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>View On Github</a>
        </div>

        <div class="right">
            <h5 class="github-invite">Explore the community</h5>
            <div class="social">
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
        </div>
        <div class="clear" style="clear: both"></div>
        </main>
    </nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
  <h1>Tasks</h1>
  <h5>Step-by-step instructions for performing operations with Kubernetes.</h5>
  <div id="vendorStrip" class="light-text">
    <ul>
      <li><a href="/docs/home/" >HOME</a></li>
      <li><a href="/docs/setup/" >SETUP</a></li>
      <li><a href="/docs/concepts/" >CONCEPTS</a></li>
      <li><a href="/docs/tasks/" class="YAH">TASKS</a></li>
      <li><a href="/docs/tutorials/" >TUTORIALS</a></li>
      <li><a href="/docs/reference/" >REFERENCE</a></li>
    </ul>
    <div id="searchBox">
      <input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)" autofocus="autofocus">
    </div>
  </div>
</section>




<section id="encyclopedia">
  <div id="docsToc">
        <div class="pi-accordion">
          
  

    

    
      <a class="item" data-title="任务" href="/docs/tasks/"></a>
    
  

  
    <div class="item" data-title="Install Tools">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Install and Set Up kubectl" href="/docs/tasks/tools/install-kubectl/"></a>
    
  

  

    

    
      <a class="item" data-title="Install Minikube" href="/docs/tasks/tools/install-minikube/"></a>
    
  

  

    

    
      <a class="item" data-title="安装 kubeadm" href="/docs/setup/independent/install-kubeadm/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Configure Pods and Containers">
      <div class="container">
        
  

    

    
      <a class="item" data-title="给容器和Pod分配内存资源" href="/docs/tasks/configure-pod-container/assign-memory-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="给容器和Pod分配CPU资源" href="/docs/tasks/configure-pod-container/assign-cpu-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="给 Pod 配置服务质量等级" href="/docs/tasks/configure-pod-container/quality-service-pod/"></a>
    
  

  

    

    
      <a class="item" data-title="Assign CPU and RAM Resources to a Container" href="/docs/tasks/configure-pod-container/assign-cpu-ram-container/"></a>
    
  

  

    

    
      <a class="item" data-title="Assign Opaque Integer Resources to a Container" href="/docs/tasks/configure-pod-container/opaque-integer-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="配置Pod使用卷作为存储" href="/docs/tasks/configure-pod-container/configure-volume-storage/"></a>
    
  

  

    

    
      <a class="item" data-title="" href="/docs/tasks/configure-pod-container/configure-persistent-volume-storage/"></a>
    
  

  

    

    
      <a class="item" data-title="配置Pod使用配套的存储卷作为存储" href="/docs/tasks/configure-pod-container/configure-projected-volume-storage/"></a>
    
  

  

    

    
  

  

    

    
      <a class="item" data-title="Configure a Security Context for a Pod or Container" href="/docs/tasks/configure-pod-container/security-context/"></a>
    
  

  

    

    
  

  

    

    
      <a class="item" data-title="配置Pod的Service Account" href="/docs/tasks/configure-pod-container/configure-service-account/"></a>
    
  

  

    

    
      <a class="item" data-title="从私有仓库拉取镜像" href="/docs/tasks/configure-pod-container/pull-image-private-registry/"></a>
    
  

  

    

    
      <a class="item" data-title="配置Liveness和Readiness探针" href="/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/"></a>
    
  

  

    

    
      <a class="item" data-title="向节点分配 Pod" href="/docs/tasks/configure-pod-container/assign-pods-nodes/"></a>
    
  

  

    

    
      <a class="item" data-title="配置Pod初始化" href="/docs/tasks/configure-pod-container/configure-pod-initialization/"></a>
    
  

  

    

    
      <a class="item" data-title="给容器生命周期设置操作事件" href="/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/"></a>
    
  

  

    

    
      <a class="item" data-title="使用ConfigMap配置容器" href="/docs/tasks/configure-pod-container/configmap/"></a>
    
  

  

    

    
      <a class="item" data-title="在 Pod 里使用 ConfigMap 数据" href="/docs/tasks/configure-pod-container/configure-pod-configmap/"></a>
    
  

  

    

    
      <a class="item" data-title="Translate a Docker Compose File to Kubernetes Resources" href="/docs/tools/kompose/user-guide/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Inject Data Into Applications">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Define a Command and Arguments for a Container" href="/docs/tasks/inject-data-application/define-command-argument-container/"></a>
    
  

  

    

    
      <a class="item" data-title="Define Environment Variables for a Container" href="/docs/tasks/inject-data-application/define-environment-variable-container/"></a>
    
  

  

    

    
      <a class="item" data-title="Expose Pod Information to Containers Through Environment Variables" href="/docs/tasks/inject-data-application/environment-variable-expose-pod-information/"></a>
    
  

  

    

    
      <a class="item" data-title="Expose Pod Information to Containers Through Files" href="/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Secrets 安全地分发凭证" href="/docs/tasks/inject-data-application/distribute-credentials-secure/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 PodPreset 将信息注入 Pods" href="/docs/tasks/inject-data-application/podpreset/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Run Applications">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Run a Stateless Application Using a Deployment" href="/docs/tasks/run-application/run-stateless-application-deployment/"></a>
    
  

  

    

    
      <a class="item" data-title="Run a Single-Instance Stateful Application" href="/docs/tasks/run-application/run-single-instance-stateful-application/"></a>
    
  

  

    

    
      <a class="item" data-title="Run a Replicated Stateful Application" href="/docs/tasks/run-application/run-replicated-stateful-application/"></a>
    
  

  

    

    
      <a class="item" data-title="Update API Objects in Place Using kubectl patch" href="/docs/tasks/run-application/update-api-object-kubectl-patch/"></a>
    
  

  

    

    
      <a class="item" data-title="Upgrade from PetSets to StatefulSets" href="/docs/tasks/run-application/upgrade-pet-set-to-stateful-set/"></a>
    
  

  

    

    
      <a class="item" data-title="Scale a StatefulSet" href="/docs/tasks/run-application/scale-stateful-set/"></a>
    
  

  

    

    
      <a class="item" data-title="删除StatefulSet" href="/docs/tasks/run-application/delete-stateful-set/"></a>
    
  

  

    

    
      <a class="item" data-title="强制删除StatefulSet中的Pod" href="/docs/tasks/run-application/force-delete-stateful-set-pod/"></a>
    
  

  

    

    
      <a class="item" data-title="Perform Rolling Update Using a Replication Controller" href="/docs/tasks/run-application/rolling-update-replication-controller/"></a>
    
  

  

    

    
      <a class="item" data-title="Horizontal Pod Autoscaling" href="/docs/tasks/run-application/horizontal-pod-autoscale/"></a>
    
  

  

    

    
      <a class="item" data-title="Pod水平自动伸缩（Horizontal Pod Autoscaling）演练" href="/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/"></a>
    
  

  

    

    
      <a class="item" data-title="指定应用程序的中断预算（Disruption Budget）" href="/docs/tasks/run-application/configure-pdb/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Run Jobs">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Parallel Processing using Expansions" href="/docs/tasks/job/parallel-processing-expansion/"></a>
    
  

  

    

    
      <a class="item" data-title="Coarse Parallel Processing Using a Work Queue" href="/docs/tasks/job/coarse-parallel-processing-work-queue/"></a>
    
  

  

    

    
      <a class="item" data-title="Fine Parallel Processing Using a Work Queue" href="/docs/tasks/job/fine-parallel-processing-work-queue/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Access Applications in a Cluster">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Web UI (Dashboard)" href="/docs/tasks/access-application-cluster/web-ui-dashboard/"></a>
    
  

  

    

    
      <a class="item" data-title="访问集群" href="/docs/tasks/access-application-cluster/access-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="配置对多集群的访问" href="/docs/tasks/access-application-cluster/configure-access-multiple-clusters/"></a>
    
  

  

    

    
      <a class="item" data-title="通过端口转发访问集群中的应用程序" href="/docs/tasks/access-application-cluster/port-forward-access-application-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="Provide Load-Balanced Access to an Application in a Cluster" href="/docs/tasks/access-application-cluster/load-balance-access-application-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 service 访问群集中的应用程序" href="/docs/tasks/access-application-cluster/service-access-application-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Service 把前端连接到后端" href="/docs/tasks/access-application-cluster/connecting-frontend-backend/"></a>
    
  

  

    

    
      <a class="item" data-title="创建一个外部负载均衡器" href="/docs/tasks/access-application-cluster/create-external-load-balancer/"></a>
    
  

  

    

    
      <a class="item" data-title="配置云平台防火墙" href="/docs/tasks/access-application-cluster/configure-cloud-provider-firewall/"></a>
    
  

  

    

    
      <a class="item" data-title="List All Container Images Running in a Cluster" href="/docs/tasks/access-application-cluster/list-all-running-container-images/"></a>
    
  

  

    

    
      <a class="item" data-title="同 Pod 内的容器使用共享卷通信" href="/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/"></a>
    
  

  

    

    
      <a class="item" data-title="Configuring DNS for a Cluster" href="https://github.com/kubernetes/kubernetes/tree/release-1.5/examples/cluster-dns"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Monitor, Log, and Debug">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Core metrics pipeline" href="/docs/tasks/debug-application-cluster/core-metrics-pipeline/"></a>
    
  

  

    

    
      <a class="item" data-title="对计算、存储和网络资源进行监控的工具" href="/docs/tasks/debug-application-cluster/resource-usage-monitoring/"></a>
    
  

  

    

    
      <a class="item" data-title="获取一个运行容器的 Shell" href="/docs/tasks/debug-application-cluster/get-shell-running-container/"></a>
    
  

  

    

    
      <a class="item" data-title="监控节点健康状况" href="/docs/tasks/debug-application-cluster/monitor-node-health/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Stackdriver 查看日志" href="/docs/tasks/debug-application-cluster/logging-stackdriver/"></a>
    
  

  

    

    
      <a class="item" data-title="Stackdriver 中的事件" href="/docs/tasks/debug-application-cluster/events-stackdriver/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Elasticsearch 和 Kibana 查看日志" href="/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/"></a>
    
  

  

    

    
      <a class="item" data-title="确定 Pod 失败的原因" href="/docs/tasks/debug-application-cluster/determine-reason-pod-failure/"></a>
    
  

  

    

    
      <a class="item" data-title="调试 Init 容器" href="/docs/tasks/debug-application-cluster/debug-init-containers/"></a>
    
  

  

    

    
      <a class="item" data-title="Debug Pods and Replication Controllers" href="/docs/tasks/debug-application-cluster/debug-pod-replication-controller/"></a>
    
  

  

    

    
      <a class="item" data-title="Debug Services" href="/docs/tasks/debug-application-cluster/debug-service/"></a>
    
  

  

    

    
      <a class="item" data-title="Troubleshoot Clusters" href="/docs/tasks/debug-application-cluster/debug-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="Troubleshoot Applications" href="/docs/tasks/debug-application-cluster/debug-application/"></a>
    
  

  

    

    
      <a class="item" data-title="Debug a StatefulSet" href="/docs/tasks/debug-application-cluster/debug-stateful-set/"></a>
    
  

  

    

    
      <a class="item" data-title="Application Introspection and Debugging" href="/docs/tasks/debug-application-cluster/debug-application-introspection/"></a>
    
  

  

    

    
      <a class="item" data-title="Auditing" href="/docs/tasks/debug-application-cluster/audit/"></a>
    
  

  

    

    
      <a class="item" data-title="Developing and debugging services locally" href="/docs/tasks/debug-application-cluster/local-debugging/"></a>
    
  

  

    

    
      <a class="item" data-title="Use Explorer to Examine the Runtime Environment" href="https://github.com/kubernetes/kubernetes/tree/release-1.5/examples/explorer"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Extend Kubernetes">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Use an HTTP Proxy to Access the Kubernetes API" href="/docs/tasks/access-kubernetes-api/http-proxy-access-api/"></a>
    
  

  

    

    
      <a class="item" data-title="使用CRD(CustomResourceDefinitions)扩展Kubernetes API" href="/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/"></a>
    
  

  

    

    
      <a class="item" data-title="Extend the Kubernetes API with ThirdPartyResources" href="/docs/tasks/access-kubernetes-api/extend-api-third-party-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="Migrate a ThirdPartyResource to CustomResourceDefinition" href="/docs/tasks/access-kubernetes-api/migrate-third-party-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="Configure the aggregation layer" href="/docs/tasks/access-kubernetes-api/configure-aggregation-layer/"></a>
    
  

  

    

    
      <a class="item" data-title="配置扩展 API 服务器" href="/docs/tasks/access-kubernetes-api/setup-extension-api-server/"></a>
    
  

  

    

    
      <a class="item" data-title="Install Service Catalog using Helm" href="/docs/tasks/service-catalog/install-service-catalog-using-helm/"></a>
    
  

  

    

    
      <a class="item" data-title="Install Service Catalog using SC" href="/docs/tasks/service-catalog/install-service-catalog-using-sc/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="TLS">
      <div class="container">
        
  

    

    
      <a class="item" data-title="管理集群中的TLS认证" href="/docs/tasks/tls/managing-tls-in-a-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="证书轮换" href="/docs/tasks/tls/certificate-rotation/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Administer a Cluster">
      <div class="container">
        
  
    <div class="item" data-title="Manage Memory, CPU, and API Resources">
      <div class="container">
        
  

    

    
      <a class="item" data-title="为命名空间配置默认的内存请求与限额" href="/docs/tasks/administer-cluster/memory-default-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="在命名空间中配置默认的CPU请求与限额" href="/docs/tasks/administer-cluster/cpu-default-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="为 Namespace 设置最小和最大内存限制" href="/docs/tasks/administer-cluster/memory-constraint-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="为 Namespace 配置最小和最大 CPU 限制" href="/docs/tasks/administer-cluster/cpu-constraint-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="应用资源配额和限额" href="/docs/tasks/administer-cluster/apply-resource-quota-limit/"></a>
    
  

  

    

    
      <a class="item" data-title="为名字空间配置CPU和内存配额（Quota）" href="/docs/tasks/administer-cluster/quota-memory-cpu-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="为名字空间配置Pod配额" href="/docs/tasks/administer-cluster/quota-pod-namespace/"></a>
    
  

  

    

    
      <a class="item" data-title="配置API对象（API Object）的配额（Quota）" href="/docs/tasks/administer-cluster/quota-api-object/"></a>
    
  

  

    

    
      <a class="item" data-title="为节点发布不透明整数资源（Opaque Integer Resources）" href="/docs/tasks/administer-cluster/opaque-integer-resource-node/"></a>
    
  

  

    

    
      <a class="item" data-title="控制节点上的CPU管理策略" href="/docs/tasks/administer-cluster/cpu-management-policies/"></a>
    
  


      </div>
    </div>
  

  

    

    
      <a class="item" data-title="通过 Kubernetes API 访问集群" href="/docs/tasks/administer-cluster/access-cluster-api/"></a>
    
  

  

    

    
      <a class="item" data-title="访问集群上运行的服务" href="/docs/tasks/administer-cluster/access-cluster-services/"></a>
    
  

  

    

    
      <a class="item" data-title="集群安全" href="/docs/tasks/administer-cluster/securing-a-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="Encrypting data at rest" href="/docs/tasks/administer-cluster/encrypt-data/"></a>
    
  

  

    

    
      <a class="item" data-title="Operating etcd clusters for Kubernetes" href="/docs/tasks/administer-cluster/configure-upgrade-etcd/"></a>
    
  

  

    

    
      <a class="item" data-title="静态 Pod" href="/docs/tasks/administer-cluster/static-pod/"></a>
    
  

  

    

    
      <a class="item" data-title="集群管理" href="/docs/tasks/administer-cluster/cluster-management/"></a>
    
  

  

    

    
      <a class="item" data-title="1.6 版本集群管理指南" href="/docs/tasks/administer-cluster/upgrade-1-6/"></a>
    
  

  

    

    
      <a class="item" data-title="将 kubeadm 集群从 1.6 升级到 1.7" href="/docs/tasks/administer-cluster/kubeadm-upgrade-1-7/"></a>
    
  

  

    

    
      <a class="item" data-title="将 kubeadm 集群从 1.7 升级到 1.8" href="/docs/tasks/administer-cluster/kubeadm-upgrade-1-8/"></a>
    
  

  

    

    
      <a class="item" data-title="使用命名空间共享一个集群" href="/docs/tasks/administer-cluster/namespaces/"></a>
    
  

  

    

    
      <a class="item" data-title="演示命名空间" href="/docs/tasks/administer-cluster/namespaces-walkthrough/"></a>
    
  

  

    

    
      <a class="item" data-title="集群 DNS Service Autoscale" href="/docs/tasks/administer-cluster/dns-horizontal-autoscaling/"></a>
    
  

  

    

    
      <a class="item" data-title="遵循应用中断预算安全移除节点" href="/docs/tasks/administer-cluster/safely-drain-node/"></a>
    
  

  

    

    
      <a class="item" data-title="设置 Pod CPU 和内存限制" href="/docs/tasks/administer-cluster/cpu-memory-limit/"></a>
    
  

  

    

    
      <a class="item" data-title="配置资源不足处理方式" href="/docs/tasks/administer-cluster/out-of-resource/"></a>
    
  

  

    

    
      <a class="item" data-title="为系统守护进程预留计算资源" href="/docs/tasks/administer-cluster/reserve-compute-resources/"></a>
    
  

  

    

    
      <a class="item" data-title="关键插件 Pod 的调度保证" href="/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/"></a>
    
  

  

    

    
      <a class="item" data-title="声明网络策略" href="/docs/tasks/administer-cluster/declare-network-policy/"></a>
    
  

  

    

    
      <a class="item" data-title="重新配置活动集群中节点的 Kubelet" href="/docs/tasks/administer-cluster/reconfigure-kubelet/"></a>
    
  

  

    

    
      <a class="item" data-title="通过配置文件设置 Kubelet 参数" href="/docs/tasks/administer-cluster/kubelet-config-file/"></a>
    
  

  
    <div class="item" data-title="Install Network Policy Provider">
      <div class="container">
        
  

    

    
      <a class="item" data-title="为了 NetworkPolicy 使用 Calico" href="/docs/tasks/administer-cluster/calico-network-policy/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Cilium 来提供 NetworkPolicy" href="/docs/tasks/administer-cluster/cilium-network-policy/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Kube-router 来提供 NetworkPolicy" href="/docs/tasks/administer-cluster/kube-router-network-policy/"></a>
    
  

  

    

    
      <a class="item" data-title="为了 NetworkPolicy 使用 Romana" href="/docs/tasks/administer-cluster/romana-network-policy/"></a>
    
  

  

    

    
      <a class="item" data-title="为了 NetworkPolicy 使用 Weave 网络" href="/docs/tasks/administer-cluster/weave-network-policy/"></a>
    
  


      </div>
    </div>
  

  

    

    
      <a class="item" data-title="更改 PersistentVolume 的回收策略" href="/docs/tasks/administer-cluster/change-pv-reclaim-policy/"></a>
    
  

  

    

    
  

  

    

    
      <a class="item" data-title="限制存储使用量" href="/docs/tasks/administer-cluster/limit-storage-consumption/"></a>
    
  

  

    

    
      <a class="item" data-title="改变默认 StorageClass" href="/docs/tasks/administer-cluster/change-default-storage-class/"></a>
    
  

  

    

    
      <a class="item" data-title="Kubernetes 云管理控制器" href="/docs/tasks/administer-cluster/running-cloud-controller/"></a>
    
  

  

    

    
      <a class="item" data-title="开发云管理控制器（Cloud Controller Manager）" href="/docs/tasks/administer-cluster/developing-cloud-controller-manager/"></a>
    
  

  

    

    
      <a class="item" data-title="建立高可用 Kubernetes Master" href="/docs/tasks/administer-cluster/highly-available-master/"></a>
    
  

  

    

    
      <a class="item" data-title="配置多个调度器" href="/docs/tasks/administer-cluster/configure-multiple-schedulers/"></a>
    
  

  

    

    
      <a class="item" data-title="IP 伪装代理用户指南" href="/docs/tasks/administer-cluster/ip-masq-agent/"></a>
    
  

  

    

    
      <a class="item" data-title="在 Kubernetes 中配置私有 DNS 和上游 nameserver" href="/docs/tasks/administer-cluster/dns-custom-nameservers/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Federation - Run an App on Multiple Clusters">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Cross-cluster Service Discovery using Federated Services" href="/docs/tasks/federation/federation-service-discovery/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 Kubefed 创建集群联邦" href="/docs/tasks/federation/set-up-cluster-federation-kubefed/"></a>
    
  

  

    

    
      <a class="item" data-title="Set up CoreDNS as DNS provider for Cluster Federation" href="/docs/tasks/federation/set-up-coredns-provider-federation/"></a>
    
  

  

    

    
      <a class="item" data-title="Set up placement policies in Federation" href="/docs/tasks/federation/set-up-placement-policies-federation/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Cluster" href="/docs/tasks/administer-federation/cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated ConfigMap" href="/docs/tasks/administer-federation/configmap/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated DaemonSet" href="/docs/tasks/administer-federation/daemonset/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Deployment" href="/docs/tasks/administer-federation/deployment/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Events" href="/docs/tasks/administer-federation/events/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Horizontal Pod Autoscalers (HPA)" href="/docs/tasks/administer-federation/hpa/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Ingress" href="/docs/tasks/administer-federation/ingress/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Jobs" href="/docs/tasks/administer-federation/job/"></a>
    
  

  

    

    
      <a class="item" data-title="联邦命名空间" href="/docs/tasks/administer-federation/namespaces/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated ReplicaSets" href="/docs/tasks/administer-federation/replicaset/"></a>
    
  

  

    

    
      <a class="item" data-title="Federated Secrets" href="/docs/tasks/administer-federation/secret/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Manage Cluster Daemons">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Perform a Rolling Update on a DaemonSet" href="/docs/tasks/manage-daemon/update-daemon-set/"></a>
    
  

  

    

    
      <a class="item" data-title="对 DaemonSet 执行回滚" href="/docs/tasks/manage-daemon/rollback-daemon-set/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Manage GPUs">
      <div class="container">
        
  

    

    
      <a class="item" data-title="调度 GPU" href="/docs/tasks/manage-gpus/scheduling-gpus/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Manage HugePages">
      <div class="container">
        
  

    

    
      <a class="item" data-title="管理巨页（HugePages）" href="/docs/tasks/manage-hugepages/scheduling-hugepages/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Extend kubectl with plugins">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Extend kubectl with plugins" href="/docs/tasks/extend-kubectl/kubectl-plugins/"></a>
    
  


      </div>
    </div>
  


        </div> <!-- /pi-accordion -->
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
  </div> <!-- /docsToc -->

  <div id="docsContent">
        <p><a href="/editdocs#docs/tasks/run-application/run-replicated-stateful-application.md" id="editPageButton">Edit This Page</a></p>

        
          <h1>Run a Replicated Stateful Application</h1>
        

        
<p>This page shows how to run a replicated stateful application using a
<a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a> controller.
The example is a MySQL single-master topology with multiple slaves running
asynchronous replication.</p>

<p>Note that <strong>this is not a production configuration</strong>.
In particular, MySQL settings remain on insecure defaults to keep the focus
on general patterns for running stateful applications in Kubernetes.</p>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#deploy-mysql" id="markdown-toc-deploy-mysql">Deploy MySQL</a>    <ul>
      <li><a href="#configmap" id="markdown-toc-configmap">ConfigMap</a></li>
      <li><a href="#services" id="markdown-toc-services">Services</a></li>
      <li><a href="#statefulset" id="markdown-toc-statefulset">StatefulSet</a></li>
    </ul>
  </li>
  <li><a href="#understanding-stateful-pod-initialization" id="markdown-toc-understanding-stateful-pod-initialization">Understanding stateful Pod initialization</a>    <ul>
      <li><a href="#generating-configuration" id="markdown-toc-generating-configuration">Generating configuration</a></li>
      <li><a href="#cloning-existing-data" id="markdown-toc-cloning-existing-data">Cloning existing data</a></li>
      <li><a href="#starting-replication" id="markdown-toc-starting-replication">Starting replication</a></li>
    </ul>
  </li>
  <li><a href="#sending-client-traffic" id="markdown-toc-sending-client-traffic">Sending client traffic</a></li>
  <li><a href="#simulating-pod-and-node-downtime" id="markdown-toc-simulating-pod-and-node-downtime">Simulating Pod and Node downtime</a>    <ul>
      <li><a href="#break-the-readiness-probe" id="markdown-toc-break-the-readiness-probe">Break the Readiness Probe</a></li>
      <li><a href="#delete-pods" id="markdown-toc-delete-pods">Delete Pods</a></li>
      <li><a href="#drain-a-node" id="markdown-toc-drain-a-node">Drain a Node</a></li>
    </ul>
  </li>
  <li><a href="#scaling-the-number-of-slaves" id="markdown-toc-scaling-the-number-of-slaves">Scaling the number of slaves</a></li>
  <li><a href="#cleaning-up" id="markdown-toc-cleaning-up">Cleaning up</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<ul>
  <li>Deploy a replicated MySQL topology with a StatefulSet controller.</li>
  <li>Send MySQL client traffic.</li>
  <li>Observe resistance to downtime.</li>
  <li>Scale the StatefulSet up and down.</li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>
    <p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>
  </li>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<ul>
  <li>
    <p>You need to either have a dynamic PersistentVolume provisioner with a default
<a href="/docs/concepts/storage/storage-classes/">StorageClass</a>,
or <a href="/docs/user-guide/persistent-volumes/#provisioning">statically provision PersistentVolumes</a>
yourself to satisfy the <a href="/docs/user-guide/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaims</a>
used here.</p>
  </li>
  <li>This tutorial assumes you are familiar with
<a href="/docs/concepts/storage/persistent-volumes/">PersistentVolumes</a>
and <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>,
as well as other core concepts like <a href="/docs/concepts/workloads/pods/pod/">Pods</a>,
<a href="/docs/concepts/services-networking/service/">Services</a>, and
<a href="/docs/tasks/configure-pod-container/configmap/">ConfigMaps</a>.</li>
  <li>Some familiarity with MySQL helps, but this tutorial aims to present
general patterns that should be useful for other systems.</li>
</ul>

<h2 id="deploy-mysql">Deploy MySQL</h2>

<p>The example MySQL deployment consists of a ConfigMap, two Services,
and a StatefulSet.</p>

<h3 id="configmap">ConfigMap</h3>

<p>Create the ConfigMap from the following YAML configuration file:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/run-application/mysql-configmap.yaml
</code></pre></div></div>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/run-application/mysql-configmap.yaml" download="mysql-configmap.yaml">
                    <code>mysql-configmap.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('mysql-configmap.yaml')" title="Copy mysql-configmap.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="mysql-configmap.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">master.cnf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="no"># Apply this config only on the master.</span>
    <span class="no">[mysqld]</span>
    <span class="no">log-bin</span>
  <span class="s">slave.cnf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="no"># Apply this config only on slaves.</span>
    <span class="no">[mysqld]</span>
    <span class="no">super-read-only</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>This ConfigMap provides <code class="highlighter-rouge">my.cnf</code> overrides that let you independently control
configuration on the MySQL master and slaves.
In this case, you want the master to be able to serve replication logs to slaves
and you want slaves to reject any writes that don’t come via replication.</p>

<p>There’s nothing special about the ConfigMap itself that causes different
portions to apply to different Pods.
Each Pod decides which portion to look at as it’s initializing,
based on information provided by the StatefulSet controller.</p>

<h3 id="services">Services</h3>

<p>Create the Services from the following YAML configuration file:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/run-application/mysql-services.yaml
</code></pre></div></div>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/run-application/mysql-services.yaml" download="mysql-services.yaml">
                    <code>mysql-services.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('mysql-services.yaml')" title="Copy mysql-services.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="mysql-services.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Headless service for stable DNS entries of StatefulSet members.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">3306</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="nn">---</span>
<span class="c1"># Client service for connecting to any MySQL instance for reads.</span>
<span class="c1"># For writes, you must instead connect to the master: mysql-0.mysql.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-read</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">3306</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>The Headless Service provides a home for the DNS entries that the StatefulSet
controller creates for each Pod that’s part of the set.
Because the Headless Service is named <code class="highlighter-rouge">mysql</code>, the Pods are accessible by
resolving <code class="highlighter-rouge">&lt;pod-name&gt;.mysql</code> from within any other Pod in the same Kubernetes
cluster and namespace.</p>

<p>The Client Service, called <code class="highlighter-rouge">mysql-read</code>, is a normal Service with its own
cluster IP that distributes connections across all MySQL Pods that report
being Ready. The set of potential endpoints includes the MySQL master and all
slaves.</p>

<p>Note that only read queries can use the load-balanced Client Service.
Because there is only one MySQL master, clients should connect directly to the
MySQL master Pod (through its DNS entry within the Headless Service) to execute
writes.</p>

<h3 id="statefulset">StatefulSet</h3>

<p>Finally, create the StatefulSet from the following YAML configuration file:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/run-application/mysql-statefulset.yaml
</code></pre></div></div>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/run-application/mysql-statefulset.yaml" download="mysql-statefulset.yaml">
                    <code>mysql-statefulset.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('mysql-statefulset.yaml')" title="Copy mysql-statefulset.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="mysql-statefulset.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta2</span> <span class="c1"># for versions before 1.8.0 use apps/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">3</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">init-mysql</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.7</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">bash</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
        <span class="pi">-</span> <span class="pi">|</span>
          <span class="no">set -ex</span>
          <span class="no"># Generate mysql server-id from pod ordinal index.</span>
          <span class="no">[[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span>
          <span class="no">ordinal=${BASH_REMATCH[1]}</span>
          <span class="no">echo [mysqld] &gt; /mnt/conf.d/server-id.cnf</span>
          <span class="no"># Add an offset to avoid reserved server-id=0 value.</span>
          <span class="no">echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf</span>
          <span class="no"># Copy appropriate conf.d files from config-map to emptyDir.</span>
          <span class="no">if [[ $ordinal -eq 0 ]]; then</span>
            <span class="no">cp /mnt/config-map/master.cnf /mnt/conf.d/</span>
          <span class="no">else</span>
            <span class="no">cp /mnt/config-map/slave.cnf /mnt/conf.d/</span>
          <span class="no">fi</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conf</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/mnt/conf.d</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-map</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/mnt/config-map</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">clone-mysql</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google-samples/xtrabackup:1.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">bash</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
        <span class="pi">-</span> <span class="pi">|</span>
          <span class="no">set -ex</span>
          <span class="no"># Skip the clone if data already exists.</span>
          <span class="no">[[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0</span>
          <span class="no"># Skip the clone on master (ordinal index 0).</span>
          <span class="no">[[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span>
          <span class="no">ordinal=${BASH_REMATCH[1]}</span>
          <span class="no">[[ $ordinal -eq 0 ]] &amp;&amp; exit 0</span>
          <span class="no"># Clone data from previous peer.</span>
          <span class="no">ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql</span>
          <span class="no"># Prepare the backup.</span>
          <span class="no">xtrabackup --prepare --target-dir=/var/lib/mysql</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conf</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/mysql/conf.d</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.7</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ALLOW_EMPTY_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
          <span class="na">containerPort</span><span class="pi">:</span> <span class="s">3306</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conf</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/mysql/conf.d</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">500m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">exec</span><span class="pi">:</span>
            <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">mysqladmin"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">ping"</span><span class="pi">]</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="s">30</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="s">10</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="s">5</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">exec</span><span class="pi">:</span>
            <span class="c1"># Check we can execute queries over TCP (skip-networking is off).</span>
            <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">mysql"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-h"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">127.0.0.1"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-e"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">SELECT</span><span class="nv"> </span><span class="s">1"</span><span class="pi">]</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="s">5</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="s">2</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="s">1</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtrabackup</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google-samples/xtrabackup:1.0</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtrabackup</span>
          <span class="na">containerPort</span><span class="pi">:</span> <span class="s">3307</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">bash</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
        <span class="pi">-</span> <span class="pi">|</span>
          <span class="no">set -ex</span>
          <span class="no">cd /var/lib/mysql</span>

          <span class="no"># Determine binlog position of cloned data, if any.</span>
          <span class="no">if [[ -f xtrabackup_slave_info ]]; then</span>
            <span class="no"># XtraBackup already generated a partial "CHANGE MASTER TO" query</span>
            <span class="no"># because we're cloning from an existing slave.</span>
            <span class="no">mv xtrabackup_slave_info change_master_to.sql.in</span>
            <span class="no"># Ignore xtrabackup_binlog_info in this case (it's useless).</span>
            <span class="no">rm -f xtrabackup_binlog_info</span>
          <span class="no">elif [[ -f xtrabackup_binlog_info ]]; then</span>
            <span class="no"># We're cloning directly from master. Parse binlog position.</span>
            <span class="no">[[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1</span>
            <span class="no">rm xtrabackup_binlog_info</span>
            <span class="no">echo "CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\</span>
                  <span class="no">MASTER_LOG_POS=${BASH_REMATCH[2]}" &gt; change_master_to.sql.in</span>
          <span class="no">fi</span>

          <span class="no"># Check if we need to complete a clone by starting replication.</span>
          <span class="no">if [[ -f change_master_to.sql.in ]]; then</span>
            <span class="no">echo "Waiting for mysqld to be ready (accepting connections)"</span>
            <span class="no">until mysql -h 127.0.0.1 -e "SELECT 1"; do sleep 1; done</span>

            <span class="no">echo "Initializing replication from clone position"</span>
            <span class="no"># In case of container restart, attempt this at-most-once.</span>
            <span class="no">mv change_master_to.sql.in change_master_to.sql.orig</span>
            <span class="no">mysql -h 127.0.0.1 &lt;&lt;EOF</span>
          <span class="no">$(&lt;change_master_to.sql.orig),</span>
            <span class="no">MASTER_HOST='mysql-0.mysql',</span>
            <span class="no">MASTER_USER='root',</span>
            <span class="no">MASTER_PASSWORD='',</span>
            <span class="no">MASTER_CONNECT_RETRY=10;</span>
          <span class="no">START SLAVE;</span>
          <span class="no">EOF</span>
          <span class="no">fi</span>

          <span class="no"># Start a server to send backups when requested by peers.</span>
          <span class="no">exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \</span>
            <span class="no">"xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conf</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/mysql/conf.d</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">100Mi</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conf</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-map</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">accessModes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ReadWriteOnce"</span><span class="pi">]</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">storage</span><span class="pi">:</span> <span class="s">10Gi</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>You can watch the startup progress by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mysql <span class="nt">--watch</span>
</code></pre></div></div>

<p>After a while, you should see all 3 Pods become Running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY     STATUS    RESTARTS   AGE
mysql-0   2/2       Running   0          2m
mysql-1   2/2       Running   0          1m
mysql-2   2/2       Running   0          1m
</code></pre></div></div>

<p>Press <strong>Ctrl+C</strong> to cancel the watch.
If you don’t see any progress, make sure you have a dynamic PersistentVolume
provisioner enabled as mentioned in the <a href="#before-you-begin">prerequisites</a>.</p>

<p>This manifest uses a variety of techniques for managing stateful Pods as part of
a StatefulSet. The next section highlights some of these techniques to explain
what happens as the StatefulSet creates Pods.</p>

<h2 id="understanding-stateful-pod-initialization">Understanding stateful Pod initialization</h2>

<p>The StatefulSet controller starts Pods one at a time, in order by their
ordinal index.
It waits until each Pod reports being Ready before starting the next one.</p>

<p>In addition, the controller assigns each Pod a unique, stable name of the form
<code class="highlighter-rouge">&lt;statefulset-name&gt;-&lt;ordinal-index&gt;</code>.
In this case, that results in Pods named <code class="highlighter-rouge">mysql-0</code>, <code class="highlighter-rouge">mysql-1</code>, and <code class="highlighter-rouge">mysql-2</code>.</p>

<p>The Pod template in the above StatefulSet manifest takes advantage of these
properties to perform orderly startup of MySQL replication.</p>

<h3 id="generating-configuration">Generating configuration</h3>

<p>Before starting any of the containers in the Pod spec, the Pod first runs any
<a href="/docs/concepts/workloads/pods/init-containers/">Init Containers</a>
in the order defined.</p>

<p>The first Init Container, named <code class="highlighter-rouge">init-mysql</code>, generates special MySQL config
files based on the ordinal index.</p>

<p>The script determines its own ordinal index by extracting it from the end of
the Pod name, which is returned by the <code class="highlighter-rouge">hostname</code> command.
Then it saves the ordinal (with a numeric offset to avoid reserved values)
into a file called <code class="highlighter-rouge">server-id.cnf</code> in the MySQL <code class="highlighter-rouge">conf.d</code> directory.
This translates the unique, stable identity provided by the StatefulSet
controller into the domain of MySQL server IDs, which require the same
properties.</p>

<p>The script in the <code class="highlighter-rouge">init-mysql</code> container also applies either <code class="highlighter-rouge">master.cnf</code> or
<code class="highlighter-rouge">slave.cnf</code> from the ConfigMap by copying the contents into <code class="highlighter-rouge">conf.d</code>.
Because the example topology consists of a single MySQL master and any number of
slaves, the script simply assigns ordinal <code class="highlighter-rouge">0</code> to be the master, and everyone
else to be slaves.
Combined with the StatefulSet controller’s
<a href="/docs/concepts/workloads/controllers/statefulset/#deployment-and-scaling-guarantees/">deployment order guarantee</a>,
this ensures the MySQL master is Ready before creating slaves, so they can begin
replicating.</p>

<h3 id="cloning-existing-data">Cloning existing data</h3>

<p>In general, when a new Pod joins the set as a slave, it must assume the MySQL
master might already have data on it. It also must assume that the replication
logs might not go all the way back to the beginning of time.
These conservative assumptions are the key to allow a running StatefulSet
to scale up and down over time, rather than being fixed at its initial size.</p>

<p>The second Init Container, named <code class="highlighter-rouge">clone-mysql</code>, performs a clone operation on
a slave Pod the first time it starts up on an empty PersistentVolume.
That means it copies all existing data from another running Pod,
so its local state is consistent enough to begin replicating from the master.</p>

<p>MySQL itself does not provide a mechanism to do this, so the example uses a
popular open-source tool called Percona XtraBackup.
During the clone, the source MySQL server might suffer reduced performance.
To minimize impact on the MySQL master, the script instructs each Pod to clone
from the Pod whose ordinal index is one lower.
This works because the StatefulSet controller always ensures Pod <code class="highlighter-rouge">N</code> is
Ready before starting Pod <code class="highlighter-rouge">N+1</code>.</p>

<h3 id="starting-replication">Starting replication</h3>

<p>After the Init Containers complete successfully, the regular containers run.
The MySQL Pods consist of a <code class="highlighter-rouge">mysql</code> container that runs the actual <code class="highlighter-rouge">mysqld</code>
server, and an <code class="highlighter-rouge">xtrabackup</code> container that acts as a
<a href="http://blog.kubernetes.io/2015/06/the-distributed-system-toolkit-patterns.html">sidecar</a>.</p>

<p>The <code class="highlighter-rouge">xtrabackup</code> sidecar looks at the cloned data files and determines if
it’s necessary to initialize MySQL replication on the slave.
If so, it waits for <code class="highlighter-rouge">mysqld</code> to be ready and then executes the
<code class="highlighter-rouge">CHANGE MASTER TO</code> and <code class="highlighter-rouge">START SLAVE</code> commands with replication parameters
extracted from the XtraBackup clone files.</p>

<p>Once a slave begins replication, it remembers its MySQL master and
reconnects automatically if the server restarts or the connection dies.
Also, because slaves look for the master at its stable DNS name
(<code class="highlighter-rouge">mysql-0.mysql</code>), they automatically find the master even if it gets a new
Pod IP due to being rescheduled.</p>

<p>Lastly, after starting replication, the <code class="highlighter-rouge">xtrabackup</code> container listens for
connections from other Pods requesting a data clone.
This server remains up indefinitely in case the StatefulSet scales up, or in
case the next Pod loses its PersistentVolumeClaim and needs to redo the clone.</p>

<h2 id="sending-client-traffic">Sending client traffic</h2>

<p>You can send test queries to the MySQL master (hostname <code class="highlighter-rouge">mysql-0.mysql</code>)
by running a temporary container with the <code class="highlighter-rouge">mysql:5.7</code> image and running the
<code class="highlighter-rouge">mysql</code> client binary.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run mysql-client <span class="nt">--image</span><span class="o">=</span>mysql:5.7 <span class="nt">-i</span> <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span><span class="se">\</span>
  mysql <span class="nt">-h</span> mysql-0.mysql <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
CREATE DATABASE test;
CREATE TABLE test.messages (message VARCHAR(250));
INSERT INTO test.messages VALUES ('hello');
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Use the hostname <code class="highlighter-rouge">mysql-read</code> to send test queries to any server that reports
being Ready:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run mysql-client <span class="nt">--image</span><span class="o">=</span>mysql:5.7 <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span><span class="se">\</span>
  mysql <span class="nt">-h</span> mysql-read <span class="nt">-e</span> <span class="s2">"SELECT * FROM test.messages"</span>
</code></pre></div></div>

<p>You should get output like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
+---------+
| message |
+---------+
| hello   |
+---------+
pod "mysql-client" deleted
</code></pre></div></div>

<p>To demonstrate that the <code class="highlighter-rouge">mysql-read</code> Service distributes connections across
servers, you can run <code class="highlighter-rouge">SELECT @@server_id</code> in a loop:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run mysql-client-loop <span class="nt">--image</span><span class="o">=</span>mysql:5.7 <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span><span class="se">\</span>
  bash <span class="nt">-ic</span> <span class="s2">"while sleep 1; do mysql -h mysql-read -e 'SELECT @@server_id,NOW()'; done"</span>
</code></pre></div></div>

<p>You should see the reported <code class="highlighter-rouge">@@server_id</code> change randomly, because a different
endpoint might be selected upon each connection attempt:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         100 | 2006-01-02 15:04:05 |
+-------------+---------------------+
+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         102 | 2006-01-02 15:04:06 |
+-------------+---------------------+
+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         101 | 2006-01-02 15:04:07 |
+-------------+---------------------+
</code></pre></div></div>

<p>You can press <strong>Ctrl+C</strong> when you want to stop the loop, but it’s useful to keep
it running in another window so you can see the effects of the following steps.</p>

<h2 id="simulating-pod-and-node-downtime">Simulating Pod and Node downtime</h2>

<p>To demonstrate the increased availability of reading from the pool of slaves
instead of a single server, keep the <code class="highlighter-rouge">SELECT @@server_id</code> loop from above
running while you force a Pod out of the Ready state.</p>

<h3 id="break-the-readiness-probe">Break the Readiness Probe</h3>

<p>The <a href="/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-readiness-probes">readiness probe</a>
for the <code class="highlighter-rouge">mysql</code> container runs the command <code class="highlighter-rouge">mysql -h 127.0.0.1 -e 'SELECT 1'</code>
to make sure the server is up and able to execute queries.</p>

<p>One way to force this readiness probe to fail is to break that command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec </span>mysql-2 <span class="nt">-c</span> mysql <span class="nt">--</span> mv /usr/bin/mysql /usr/bin/mysql.off
</code></pre></div></div>

<p>This reaches into the actual container’s filesystem for Pod <code class="highlighter-rouge">mysql-2</code> and
renames the <code class="highlighter-rouge">mysql</code> command so the readiness probe can’t find it.
After a few seconds, the Pod should report one of its containers as not Ready,
which you can check by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod mysql-2
</code></pre></div></div>

<p>Look for <code class="highlighter-rouge">1/2</code> in the <code class="highlighter-rouge">READY</code> column:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY     STATUS    RESTARTS   AGE
mysql-2   1/2       Running   0          3m
</code></pre></div></div>

<p>At this point, you should see your <code class="highlighter-rouge">SELECT @@server_id</code> loop continue to run,
although it never reports <code class="highlighter-rouge">102</code> anymore.
Recall that the <code class="highlighter-rouge">init-mysql</code> script defined <code class="highlighter-rouge">server-id</code> as <code class="highlighter-rouge">100 + $ordinal</code>,
so server ID <code class="highlighter-rouge">102</code> corresponds to Pod <code class="highlighter-rouge">mysql-2</code>.</p>

<p>Now repair the Pod and it should reappear in the loop output
after a few seconds:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec </span>mysql-2 <span class="nt">-c</span> mysql <span class="nt">--</span> mv /usr/bin/mysql.off /usr/bin/mysql
</code></pre></div></div>

<h3 id="delete-pods">Delete Pods</h3>

<p>The StatefulSet also recreates Pods if they’re deleted, similar to what a
ReplicaSet does for stateless Pods.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pod mysql-2
</code></pre></div></div>

<p>The StatefulSet controller notices that no <code class="highlighter-rouge">mysql-2</code> Pod exists anymore,
and creates a new one with the same name and linked to the same
PersistentVolumeClaim.
You should see server ID <code class="highlighter-rouge">102</code> disappear from the loop output for a while
and then return on its own.</p>

<h3 id="drain-a-node">Drain a Node</h3>

<p>If your Kubernetes cluster has multiple Nodes, you can simulate Node downtime
(such as when Nodes are upgraded) by issuing a
<a href="/docs/user-guide/kubectl/v1.8/#drain">drain</a>.</p>

<p>First determine which Node one of the MySQL Pods is on:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod mysql-2 <span class="nt">-o</span> wide
</code></pre></div></div>

<p>The Node name should show up in the last column:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY     STATUS    RESTARTS   AGE       IP            NODE
mysql-2   2/2       Running   0          15m       10.244.5.27   kubernetes-minion-group-9l2t
</code></pre></div></div>

<p>Then drain the Node by running the following command, which cordons it so
no new Pods may schedule there, and then evicts any existing Pods.
Replace <code class="highlighter-rouge">&lt;node-name&gt;</code> with the name of the Node you found in the last step.</p>

<p>This might impact other applications on the Node, so it’s best to
<strong>only do this in a test cluster</strong>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl drain &lt;node-name&gt; <span class="nt">--force</span> <span class="nt">--delete-local-data</span> <span class="nt">--ignore-daemonsets</span>
</code></pre></div></div>

<p>Now you can watch as the Pod reschedules on a different Node:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod mysql-2 <span class="nt">-o</span> wide <span class="nt">--watch</span>
</code></pre></div></div>

<p>It should look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY   STATUS          RESTARTS   AGE       IP            NODE
mysql-2   2/2     Terminating     0          15m       10.244.1.56   kubernetes-minion-group-9l2t
[...]
mysql-2   0/2     Pending         0          0s        &lt;none&gt;        kubernetes-minion-group-fjlm
mysql-2   0/2     Init:0/2        0          0s        &lt;none&gt;        kubernetes-minion-group-fjlm
mysql-2   0/2     Init:1/2        0          20s       10.244.5.32   kubernetes-minion-group-fjlm
mysql-2   0/2     PodInitializing 0          21s       10.244.5.32   kubernetes-minion-group-fjlm
mysql-2   1/2     Running         0          22s       10.244.5.32   kubernetes-minion-group-fjlm
mysql-2   2/2     Running         0          30s       10.244.5.32   kubernetes-minion-group-fjlm
</code></pre></div></div>

<p>And again, you should see server ID <code class="highlighter-rouge">102</code> disappear from the
<code class="highlighter-rouge">SELECT @@server_id</code> loop output for a while and then return.</p>

<p>Now uncordon the Node to return it to a normal state:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl uncordon &lt;node-name&gt;
</code></pre></div></div>

<h2 id="scaling-the-number-of-slaves">Scaling the number of slaves</h2>

<p>With MySQL replication, you can scale your read query capacity by adding slaves.
With StatefulSet, you can do this with a single command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale statefulset mysql  <span class="nt">--replicas</span><span class="o">=</span>5
</code></pre></div></div>

<p>Watch the new Pods come up by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mysql <span class="nt">--watch</span>
</code></pre></div></div>

<p>Once they’re up, you should see server IDs <code class="highlighter-rouge">103</code> and <code class="highlighter-rouge">104</code> start appearing in
the <code class="highlighter-rouge">SELECT @@server_id</code> loop output.</p>

<p>You can also verify that these new servers have the data you added before they
existed:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run mysql-client <span class="nt">--image</span><span class="o">=</span>mysql:5.7 <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span><span class="se">\</span>
  mysql <span class="nt">-h</span> mysql-3.mysql <span class="nt">-e</span> <span class="s2">"SELECT * FROM test.messages"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
+---------+
| message |
+---------+
| hello   |
+---------+
pod "mysql-client" deleted
</code></pre></div></div>

<p>Scaling back down is also seamless:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale statefulset mysql <span class="nt">--replicas</span><span class="o">=</span>3
</code></pre></div></div>

<p>Note, however, that while scaling up creates new PersistentVolumeClaims
automatically, scaling down does not automatically delete these PVCs.
This gives you the choice to keep those initialized PVCs around to make
scaling back up quicker, or to extract data before deleting them.</p>

<p>You can see this by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pvc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mysql
</code></pre></div></div>

<p>Which shows that all 5 PVCs still exist, despite having scaled the
StatefulSet down to 3:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME           STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
data-mysql-0   Bound     pvc-8acbf5dc-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-1   Bound     pvc-8ad39820-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-2   Bound     pvc-8ad69a6d-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-3   Bound     pvc-50043c45-b1c5-11e6-93fa-42010a800002   10Gi       RWO           2m
data-mysql-4   Bound     pvc-500a9957-b1c5-11e6-93fa-42010a800002   10Gi       RWO           2m
</code></pre></div></div>

<p>If you don’t intend to reuse the extra PVCs, you can delete them:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pvc data-mysql-3
kubectl delete pvc data-mysql-4
</code></pre></div></div>

<h2 id="cleaning-up">Cleaning up</h2>

<ol>
  <li>
    <p>Cancel the <code class="highlighter-rouge">SELECT @@server_id</code> loop by pressing <strong>Ctrl+C</strong> in its terminal,
or running the following from another terminal:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pod mysql-client-loop <span class="nt">--now</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the StatefulSet. This also begins terminating the Pods.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete statefulset mysql
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that the Pods disappear.
They might take some time to finish terminating.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mysql
</code></pre></div>    </div>

    <p>You’ll know the Pods have terminated when the above returns:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>No resources found.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the ConfigMap, Services, and PersistentVolumeClaims.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete configmap,service,pvc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mysql
</code></pre></div>    </div>
  </li>
  <li>
    <p>If you manually provisioned PersistentVolumes, you also need to manually
delete them, as well as release the underlying resources.
If you used a dynamic provisioner, it automatically deletes the
PersistentVolumes when it sees that you deleted the PersistentVolumeClaims.
Some dynamic provisioners (such as those for EBS and PD) also release the
underlying resources upon deleting the PersistentVolumes.</p>
  </li>
</ol>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>Look in the <a href="https://github.com/kubernetes/charts">Helm Charts repository</a>
for other stateful application examples.</li>
</ul>



        <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/tasks/run-application/run-replicated-stateful-application.md?pixel" alt="Analytics" /></a></p>
        
	
        <script type="text/javascript">
            PDRTJS_settings_8345992 = {
                "id" : "8345992",
                "unique_id" : "/docs/tasks/run-application/run-replicated-stateful-application/",
                "title" : "Run a Replicated Stateful Application",
                "permalink" : "http://kubernetes.github.io/docs/tasks/run-application/run-replicated-stateful-application/"
            };
            (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
        </script>
        <a href="" onclick="window.open('https://github.com/kubernetes/kubernetes.github.io/issues/new?title=Issue%20with%20' +
        'k8s.io'+window.location.pathname)" class="button issue">Create an Issue</a>
	
        
          <a href="/editdocs#docs/tasks/run-application/run-replicated-stateful-application.md" class="button issue">Edit this Page</a>
        
    
    </div>
</section>

<footer>
    <main class="light-text">
        <nav>
            <a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a>
            <a href="/docs/home/">Documentation</a>
            <a href="http://blog.kubernetes.io/">Blog</a>
            <a href="/partners/">Partners</a>
            <a href="/community/">Community</a>
            <a href="/case-studies/">Case Studies</a>
        </nav>
        <div class="social">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
            <div>
                <a href="/docs/setup/pick-right-solution/" class="button">Get Kubernetes</a>
                <a href="https://github.com/kubernetes/kubernetes" class="button">Contribute</a>
            </div>
        </div>
        <div id="miceType" class="center">
            &copy; 2017 The Kubernetes Authors | Documentation Distributed under <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a>
        </div>
        <div id="miceType" class="center">
            Copyright &copy; 2017 The Linux Foundation&reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our Trademark Usage page: <a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">https://www.linuxfoundation.org/trademark-usage</a>
        </div>
    </main>
</footer>

<button class="flyout-button" onclick="kub.toggleToc()"></button>

<style>
.cse .gsc-control-cse, .gsc-control-cse, {
    padding: 0;
}
  .gsc-control-cse table, .gsc-control-cse-en table {
      margin:0px !important;
  }
  .gsc-above-wrapper-area {
      border-bottom: 0;
  }
</style>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-36037335-10', 'auto');
ga('send', 'pageview');

// hide docs nav area if no nav is present, or if nav only contains a link to the current page
(function () {
    window.addEventListener('DOMContentLoaded', init)

        // play nice with our neighbors
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
            var container = toc.querySelector('.container')

                // container is built dynamically, so it may not be present on the first runloop
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>

<!-- Commenting out AnswerDash for now; we need to work on our list of questions/answers/design first
    <!-- Start of AnswerDash script <script>var AnswerDash;!function(e,t,n,s,a){if(!t.getElementById(s)){var i,r=t.createElement(n),c=t.getElementsByTagName(n)[0];e[a]||(i=e[a]=function(){i.__oninit.push(arguments)},i.__oninit=[]),r.type="text/javascript",r.async=!0,r.src="https://p1.answerdash.com/answerdash.min.js?siteid=756",r.setAttribute("id",s),c.parentNode.insertBefore(r,c)}}(window,document,"script","answerdash-script","AnswerDash");</script> <!-- End of AnswerDash script -->


</body>
</html>
