
  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  

  
    

<!Doctype html>
<html id="docs" class="Tutorials">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" type="text/css" href="/css/styles.css"><!-- default styles.css on -->
    <link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
    <link rel="stylesheet" type="text/css" href="/css/callouts.css">
    <link rel="stylesheet" type="text/css" href="/css/custom-jekyll/tags.css">
    
    
    <!-- no custom css detected -->

    
    <meta name="description" content="示例：使用 Stateful Sets 部署 Cassandra" />
    

    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/sweetalert.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/custom-jekyll/tags.js"></script>
    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>示例：使用 Stateful Sets 部署 Cassandra | Kubernetes</title>
<meta property="og:title" content="示例：使用 Stateful Sets 部署 Cassandra" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Production-Grade Container Orchestration" />
<meta property="og:description" content="Production-Grade Container Orchestration" />
<link rel="canonical" href="http://0.0.0.0:4000/docs/tutorials/stateful-application/cassandra/" />
<meta property="og:url" content="http://0.0.0.0:4000/docs/tutorials/stateful-application/cassandra/" />
<meta property="og:site_name" content="Kubernetes" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@kubernetesio" />
<script type="application/ld+json">
{"name":null,"description":"Production-Grade Container Orchestration","author":null,"@type":"WebPage","url":"http://0.0.0.0:4000/docs/tutorials/stateful-application/cassandra/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/images/favicon.png"}},"image":null,"headline":"示例：使用 Stateful Sets 部署 Cassandra","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>

<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/" class="logo"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            <li><a href="/docs/home/">Documentation</a></li>
            <li><a href="http://blog.kubernetes.io/">Blog</a></li>
            <li><a href="/partners/">Partners</a></li>
            <li><a href="/community/">Community</a></li>
            <li><a href="/case-studies/">Case Studies</a></li>
            <li>
                <a href="#">
                    v1.8 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                  <li><a href="https://kubernetes.io/docs/home/">v1.8</a></li>
                
                  <li><a href="https://v1-7.docs.kubernetes.io/docs/home/">v1.7</a></li>
                
                  <li><a href="https://v1-6.docs.kubernetes.io/docs/home/">v1.6</a></li>
                
                  <li><a href="https://v1-5.docs.kubernetes.io/docs/">v1.5</a></li>
                
                  <li><a href="https://v1-4.docs.kubernetes.io/docs/">v1.4</a></li>
                
                </ul>
              </li>
            </li>
        </ul>
        <!-- <a href="/docs/home" class="button" id="viewDocs" data-auto-burger-exclude>View Documentation</a> -->
        <a href="/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>Try Kubernetes</a>
        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <main data-auto-burger="primary">
        <div class="nav-box">
            <h3><a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a></h3>
            <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>
        </div>
        <div class="nav-box">
            <h3><a href="/docs/home/">Documentation</a></h3>
            <p>Learn how to use Kubernetes with the use of walkthroughs, samples, and reference documentation. You can even <a href="/editdocs/" data-auto-burger-exclude>help contribute to the docs</a>!</p>
        </div>
        <div class="nav-box">
            <h3><a href="/community/">Community</a></h3>
            <p>If you need help, you can connect with other Kubernetes users and the Kubernetes authors, attend community events, and watch video presentations from around the web.</p>
        </div>
        <div class="nav-box">
            <h3><a href="http://blog.kubernetes.io">Blog</a></h3>
            <p>Read the latest news for Kubernetes and the containers space in general, and get technical how-tos hot off the presses.</p>
        </div>
        </main>
        <main data-auto-burger="primary">
        <div class="left">
            <h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
            <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>View On Github</a>
        </div>

        <div class="right">
            <h5 class="github-invite">Explore the community</h5>
            <div class="social">
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
        </div>
        <div class="clear" style="clear: both"></div>
        </main>
    </nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
  <h1>Tutorials</h1>
  <h5>Detailed walkthroughs of common Kubernetes operations and workflows.</h5>
  <div id="vendorStrip" class="light-text">
    <ul>
      <li><a href="/docs/home/" >HOME</a></li>
      <li><a href="/docs/setup/" >SETUP</a></li>
      <li><a href="/docs/concepts/" >CONCEPTS</a></li>
      <li><a href="/docs/tasks/" >TASKS</a></li>
      <li><a href="/docs/tutorials/" class="YAH">TUTORIALS</a></li>
      <li><a href="/docs/reference/" >REFERENCE</a></li>
    </ul>
    <div id="searchBox">
      <input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)" autofocus="autofocus">
    </div>
  </div>
</section>




<section id="encyclopedia">
  <div id="docsToc">
        <div class="pi-accordion">
          
  

    

    
      <a class="item" data-title="Tutorials" href="/docs/tutorials/"></a>
    
  

  
    <div class="item" data-title="Kubernetes Basics">
      <div class="container">
        
  

    

    
      <a class="item" data-title="概述" href="/docs/tutorials/kubernetes-basics/"></a>
    
  

  
    <div class="item" data-title="1. Create a Cluster">
      <div class="container">
        
  

    

    
      <a class="item" data-title="使用 Minikube 创建一个集群" href="/docs/tutorials/kubernetes-basics/cluster-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 创建集群" href="/docs/tutorials/kubernetes-basics/cluster-interactive/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="2. Deploy an App">
      <div class="container">
        
  

    

    
      <a class="item" data-title="使用 kubectl 创建部署" href="/docs/tutorials/kubernetes-basics/deploy-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 部署应用程序" href="/docs/tutorials/kubernetes-basics/deploy-interactive/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="3. Explore Your App">
      <div class="container">
        
  

    

    
      <a class="item" data-title="查看 Pods 和节点" href="/docs/tutorials/kubernetes-basics/explore-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 应用程序探索" href="/docs/tutorials/kubernetes-basics/explore-interactive/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="4. Expose Your App Publicly">
      <div class="container">
        
  

    

    
      <a class="item" data-title="使用服务发布您的应用程序" href="/docs/tutorials/kubernetes-basics/expose-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 应用外部可见" href="/docs/tutorials/kubernetes-basics/expose-interactive/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="5. Scale Your App">
      <div class="container">
        
  

    

    
      <a class="item" data-title="运行应用程序的多个实例" href="/docs/tutorials/kubernetes-basics/scale-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 扩展您的应用程序" href="/docs/tutorials/kubernetes-basics/scale-interactive/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="6. Update Your App">
      <div class="container">
        
  

    

    
      <a class="item" data-title="执行滚动更新" href="/docs/tutorials/kubernetes-basics/update-intro/"></a>
    
  

  

    

    
      <a class="item" data-title="互动教程 - 更新您的应用程序" href="/docs/tutorials/kubernetes-basics/update-interactive/"></a>
    
  


      </div>
    </div>
  


      </div>
    </div>
  

  
    <div class="item" data-title="Online Training Courses">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Scalable Microservices with Kubernetes (Udacity)" href="https://www.udacity.com/course/scalable-microservices-with-kubernetes--ud615"></a>
    
  

  

    

    
      <a class="item" data-title="Introduction to Kubernetes (edX)" href="https://www.edx.org/course/introduction-kubernetes-linuxfoundationx-lfs158x#"></a>
    
  


      </div>
    </div>
  

  

    

    
      <a class="item" data-title="Hello Minikube" href="/docs/tutorials/stateless-application/hello-minikube/"></a>
    
  

  

    

    
      <a class="item" data-title="Kubernetes 101" href="/docs/user-guide/walkthrough/"></a>
    
  

  

    

    
      <a class="item" data-title="Kubernetes 201" href="/docs/user-guide/walkthrough/k8s201/"></a>
    
  

  
    <div class="item" data-title="Configuration">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Configuring Redis using a ConfigMap" href="/docs/tutorials/configuration/configure-redis-using-configmap/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Object Management Using kubectl">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Kubernetes 对象管理" href="/docs/tutorials/object-management-kubectl/object-management/"></a>
    
  

  

    

    
      <a class="item" data-title="使用命令式的方式管理 Kubernetes 对象" href="/docs/tutorials/object-management-kubectl/imperative-object-management-command/"></a>
    
  

  

    

    
      <a class="item" data-title="Imperative Management of Kubernetes Objects Using Configuration Files" href="/docs/tutorials/object-management-kubectl/imperative-object-management-configuration/"></a>
    
  

  

    

    
      <a class="item" data-title="Declarative Management of Kubernetes Objects Using Configuration Files" href="/docs/tutorials/object-management-kubectl/declarative-object-management-configuration/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Stateless Applications">
      <div class="container">
        
  

    

    
      <a class="item" data-title="Run a Stateless Application Using a Deployment" href="/docs/tasks/run-application/run-stateless-application-deployment/"></a>
    
  

  

    

    
      <a class="item" data-title="示例：使用 Redis 的 PHP Guestbook 应用程序" href="/docs/tutorials/stateless-application/guestbook/"></a>
    
  

  

    

    
      <a class="item" data-title="使用 service 访问群集中的应用程序" href="/docs/tasks/access-application-cluster/service-access-application-cluster/"></a>
    
  

  

    

    
      <a class="item" data-title="Exposing an External IP Address to Access an Application in a Cluster" href="/docs/tutorials/stateless-application/expose-external-ip-address/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Stateful Applications">
      <div class="container">
        
  

    

    
      <a class="item" data-title="StatefulSet基本使用" href="/docs/tutorials/stateful-application/basic-stateful-set/"></a>
    
  

  

    

    
      <a class="item" data-title="Run a Single-Instance Stateful Application" href="/docs/tasks/run-application/run-single-instance-stateful-application/"></a>
    
  

  

    

    
      <a class="item" data-title="Run a Replicated Stateful Application" href="/docs/tasks/run-application/run-replicated-stateful-application/"></a>
    
  

  

    

    
      <a class="item" data-title="示例：基于 Persistent Volume 部署 WordPress 和 MySQL" href="/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/"></a>
    
  

  

    

    
      <a class="item" data-title="示例：使用 Stateful Sets 部署 Cassandra" href="/docs/tutorials/stateful-application/cassandra/"></a>
    
  

  

    

    
      <a class="item" data-title="运行 ZooKeeper， 一个 CP 分布式系统" href="/docs/tutorials/stateful-application/zookeeper/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Clusters">
      <div class="container">
        
  

    

    
      <a class="item" data-title="AppArmor" href="/docs/tutorials/clusters/apparmor/"></a>
    
  


      </div>
    </div>
  

  
    <div class="item" data-title="Services">
      <div class="container">
        
  

    

    
      <a class="item" data-title="使用 Source IP" href="/docs/tutorials/services/source-ip/"></a>
    
  


      </div>
    </div>
  


        </div> <!-- /pi-accordion -->
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
  </div> <!-- /docsToc -->

  <div id="docsContent">
        <p><a href="/editdocs#docs/tutorials/stateful-application/cassandra.md" id="editPageButton">Edit This Page</a></p>

        
          <h1>示例：使用 Stateful Sets 部署 Cassandra</h1>
        

        
<p>本教程展示了如何在 Kubernetes 上开发一个云原生的 <a href="http://cassandra.apache.org/">Cassandra</a> deployment。在这个实例中，Cassandra 使用了一个自定义的  <code class="highlighter-rouge">SeedProvider</code> 来发现新加入集群的节点。</p>

<p>在集群环境中部署类似 Cassandra 的有状态（stateful）应用可能是具有挑战性的。StatefulSets 极大的简化了这个过程。请阅读 <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a> 获取更多关于此教程中使用的这个特性的信息。</p>

<p><strong>Cassandra Docker</strong></p>

<p>Pod 使用了来自 Google <a href="https://cloud.google.com/container-registry/docs/">容器注册表（container registry）</a> 的  <a href="https://github.com/kubernetes/examples/blob/master/cassandra/image/Dockerfile"><code class="highlighter-rouge">gcr.io/google-samples/cassandra:v12</code></a> 镜像。这个 docker 镜像基于 <code class="highlighter-rouge">debian:jessie</code> 并包含 OpenJDK 8。这个镜像包含了来自 Apache Debian 源的标准 Cassandra 安装。您可以通过环境变量来改变插入到 <code class="highlighter-rouge">cassandra.yaml</code> 中的值。</p>

<table>
  <thead>
    <tr>
      <th>ENV VAR</th>
      <th style="text-align: center">DEFAULT VALUE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CASSANDRA_CLUSTER_NAME</td>
      <td style="text-align: center">‘Test Cluster’</td>
    </tr>
    <tr>
      <td>CASSANDRA_NUM_TOKENS</td>
      <td style="text-align: center">32</td>
    </tr>
    <tr>
      <td>CASSANDRA_RPC_ADDRESS</td>
      <td style="text-align: center">0.0.0.0</td>
    </tr>
  </tbody>
</table>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a>    <ul>
      <li><a href="#minikube-附加安装说明" id="markdown-toc-minikube-附加安装说明">Minikube 附加安装说明</a></li>
    </ul>
  </li>
  <li><a href="#创建--cassandra-headless-service" id="markdown-toc-创建--cassandra-headless-service">创建  Cassandra Headless Service</a>    <ul>
      <li><a href="#验证可选" id="markdown-toc-验证可选">验证（可选）</a></li>
    </ul>
  </li>
  <li><a href="#使用-statefulset-创建-cassandra-环" id="markdown-toc-使用-statefulset-创建-cassandra-环">使用 StatefulSet 创建 Cassandra 环</a></li>
  <li><a href="#验证-cassandra-statefulset" id="markdown-toc-验证-cassandra-statefulset">验证 Cassandra StatefulSet</a></li>
  <li><a href="#修改-cassandra-statefulset" id="markdown-toc-修改-cassandra-statefulset">修改 Cassandra StatefulSet</a></li>
  <li><a href="#cleaning-up" id="markdown-toc-cleaning-up">Cleaning up</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<ul>
  <li>创建并验证 Cassandra headless <a href="/docs/concepts/services-networking/service/">Services</a>。</li>
  <li>使用  <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a> 创建 Cassandra  环（Cassandra ring）。</li>
  <li>验证 <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>。</li>
  <li>修改 <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>。</li>
  <li>删除 <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a> 和它的 <a href="/docs/concepts/workloads/pods/pod/">Pod</a>。</li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>为了完成本教程，你应该对 <a href="/docs/concepts/workloads/pods/pod/">Pod</a>、 <a href="/docs/concepts/services-networking/service/">Service</a> 和 <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a> 有基本的了解。此外，你还应该：</p>

<ul>
  <li>
    <p><a href="/docs/tasks/tools/install-kubectl/">安装并配置 </a> <code class="highlighter-rouge">kubectl</code> 命令行工具</p>
  </li>
  <li>
    <p>下载  <a href="/docs/tutorials/stateful-application/cassandra/cassandra-service.yaml">cassandra-service.yaml</a> 和 <a href="/docs/tutorials/stateful-application/cassandra/cassandra-statefulset.yaml">cassandra-statefulset.yaml</a></p>
  </li>
  <li>
    <p>有一个支持（这些功能）并正常运行的 Kubernetes 集群</p>
  </li>
</ul>

<p class="note"><strong>注意：</strong> 如果你还没有集群，请查阅 <a href="/docs/setup/pick-right-solution/">快速入门指南</a>。</p>

<h3 id="minikube-附加安装说明">Minikube 附加安装说明</h3>

<p class="caution"><strong>小心：</strong> <a href="/docs/getting-started-guides/minikube/">Minikube</a> 默认配置 1024MB 内存和 1 CPU，这在本例中将导致资源不足。</p>

<p>为了避免这些错误，请这样运行 minikube：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube start --memory 5120 --cpus=4
</code></pre></div></div>

<h2 id="创建--cassandra-headless-service">创建  Cassandra Headless Service</h2>

<p>Kubernetes <a href="/docs/concepts/services-networking/service/">Service</a> 描述了一个执行相同任务的 <a href="/docs/concepts/workloads/pods/pod/">Pod</a> 集合。</p>

<p>下面的 <code class="highlighter-rouge">Service</code> 用于在集群内部的 Cassandra Pod 和客户端之间进行 DNS 查找。</p>

<ol>
  <li>在下载清单文件的文件夹下启动一个终端窗口。</li>
  <li>
    <p>使用 <code class="highlighter-rouge">cassandra-service.yaml</code> 文件创建一个 <code class="highlighter-rouge">Service</code>，用于追踪所有的 Cassandra StatefulSet  节点。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f cassandra-service.yaml
</code></pre></div>    </div>
  </li>
</ol>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tutorials/stateful-application/cassandra/cassandra-service.yaml" download="cassandra/cassandra-service.yaml">
                    <code>cassandra/cassandra-service.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('cassandra/cassandra-service.yaml')" title="Copy cassandra/cassandra-service.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="cassandra/cassandra-service.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">9042</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<h3 id="验证可选">验证（可选）</h3>

<p>获取 Cassandra <code class="highlighter-rouge">Service</code>。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get svc cassandra
</code></pre></div></div>

<p>响应应该像这样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
cassandra   None         &lt;none&gt;        9042/TCP   45s
</code></pre></div></div>

<p>如果返回了任何其它消息，这个 service 就没有被成功创建。请查阅 <a href="/docs/tasks/debug-application-cluster/debug-service/">调试 Services</a>，了解常见问题。</p>

<h2 id="使用-statefulset-创建-cassandra-环">使用 StatefulSet 创建 Cassandra 环</h2>

<p>上文中的 StatefulSet 清单文件将创建一个由 3 个 pod 组成的 Cassandra 环。</p>

<p class="note"><strong>注意：</strong> 本例中的 Minikube 使用默认 provisioner。请根据您使用的云服务商更新下面的 StatefulSet。</p>

<ol>
  <li>如有必要请修改 StatefulSet。</li>
  <li>
    <p>使用  <code class="highlighter-rouge">cassandra-statefulset.yaml</code> 文件创建 Cassandra StatefulSet。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f cassandra-statefulset.yaml
</code></pre></div>    </div>
  </li>
</ol>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tutorials/stateful-application/cassandra/cassandra-statefulset.yaml" download="cassandra/cassandra-statefulset.yaml">
                    <code>cassandra/cassandra-statefulset.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('cassandra/cassandra-statefulset.yaml')" title="Copy cassandra/cassandra-statefulset.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="cassandra/cassandra-statefulset.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google-samples/cassandra:v12</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">7000</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">intra-node</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">7001</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">tls-intra-node</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">7199</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">jmx</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">9042</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">cql</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
          <span class="na">requests</span><span class="pi">:</span>
           <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
           <span class="na">memory</span><span class="pi">:</span> <span class="s">1Gi</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">IPC_LOCK</span>
        <span class="na">lifecycle</span><span class="pi">:</span>
          <span class="na">preStop</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">PID=$(pidof</span><span class="nv"> </span><span class="s">java)</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">kill</span><span class="nv"> </span><span class="s">$PID</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">while</span><span class="nv"> </span><span class="s">ps</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">$PID</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/dev/null;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1;</span><span class="nv"> </span><span class="s">done"</span><span class="pi">]</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MAX_HEAP_SIZE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">512M</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">HEAP_NEWSIZE</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">100M</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CASSANDRA_SEEDS</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cassandra-0.cassandra.default.svc.cluster.local"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CASSANDRA_CLUSTER_NAME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">K8Demo"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CASSANDRA_DC</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">DC1-K8Demo"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CASSANDRA_RACK</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Rack1-K8Demo"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CASSANDRA_AUTO_BOOTSTRAP</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_IP</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">fieldRef</span><span class="pi">:</span>
                <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.podIP</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">exec</span><span class="pi">:</span>
            <span class="na">command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">/bin/bash</span>
            <span class="pi">-</span> <span class="s">-c</span>
            <span class="pi">-</span> <span class="s">/ready-probe.sh</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="s">15</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="s">5</span>
        <span class="c1"># These volume mounts are persistent. They are like inline claims,</span>
        <span class="c1"># but not exactly because the names need to match exactly one of</span>
        <span class="c1"># the stateful pod volumes.</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/cassandra_data</span>
  <span class="c1"># These are converted to volume claims by the controller</span>
  <span class="c1"># and mounted at the paths mentioned above.</span>
  <span class="c1"># do not use these in production until ssd GCEPersistentDisk or other ssd pd</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra-data</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">volume.beta.kubernetes.io/storage-class</span><span class="pi">:</span> <span class="s">fast</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">accessModes</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">ReadWriteOnce"</span> <span class="pi">]</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">storage</span><span class="pi">:</span> <span class="s">1Gi</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="na">provisioner</span><span class="pi">:</span> <span class="s">k8s.io/minikube-hostpath</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">pd-ssd</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<h2 id="验证-cassandra-statefulset">验证 Cassandra StatefulSet</h2>

<ol>
  <li>
    <p>获取 Cassandra StatefulSet：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get statefulset cassandra
</code></pre></div>    </div>

    <p>响应应该是</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        DESIRED   CURRENT   AGE
cassandra   3         0         13s
</code></pre></div>    </div>

    <p>StatefulSet 资源顺序的部署 pod。</p>
  </li>
  <li>
    <p>获取 pod， 查看顺序创建的状态：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -l="app=cassandra"
</code></pre></div>    </div>

    <p>响应应该像是</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME          READY     STATUS              RESTARTS   AGE
cassandra-0   1/1       Running             0          1m
cassandra-1   0/1       ContainerCreating   0          8s
</code></pre></div>    </div>

    <p class="note"><strong>注意：</strong> 部署全部三个 pod 可能需要 10 分钟时间。</p>

    <p>一旦所有 pod 都已经部署，相同的命令将返回：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME          READY     STATUS    RESTARTS   AGE
cassandra-0   1/1       Running   0          10m
cassandra-1   1/1       Running   0          9m
cassandra-2   1/1       Running   0          8m
</code></pre></div>    </div>
  </li>
  <li>
    <p>运行 Cassandra nodetool 工具，显示环的状态。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec cassandra-0 -- nodetool status
</code></pre></div>    </div>

    <p>响应为：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Datacenter: DC1-K8Demo
======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address     Load       Tokens       Owns (effective)  Host ID                               Rack
UN  172.17.0.5  83.57 KiB  32           74.0%             e2dd09e6-d9d3-477e-96c5-45094c08db0f  Rack1-K8Demo
UN  172.17.0.4  101.04 KiB  32           58.8%             f89d6835-3a42-4419-92b3-0e62cae1479c  Rack1-K8Demo
UN  172.17.0.6  84.74 KiB  32           67.1%             a6a1e8c2-3dc5-4417-b1a0-26507af2aaad  Rack1-K8Demo
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="修改-cassandra-statefulset">修改 Cassandra StatefulSet</h2>

<p>使用 <code class="highlighter-rouge">kubectl edit</code>修改 Cassandra StatefulSet 的大小。</p>

<ol>
  <li>
    <p>运行下面的命令：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl edit statefulset cassandra
</code></pre></div>    </div>

    <p>这个命令将在终端中打开一个编辑器。您需要修改 <code class="highlighter-rouge">replicas</code> 字段一行。</p>

    <p class="note"><strong>注意：</strong> 以下示例是 StatefulSet 文件的摘录。</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># Please edit the object below. Lines beginning with a '#' will be ignored,</span>
 <span class="c1"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
 <span class="c1"># reopened with the relevant failures.</span>
 <span class="c1">#</span>
 <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
 <span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="s">2016-08-13T18:40:58Z</span>
  <span class="na">generation</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">323"</span>
  <span class="na">selfLink</span><span class="pi">:</span> <span class="s">/apis/apps/v1beta1/namespaces/default/statefulsets/cassandra</span>
  <span class="na">uid</span><span class="pi">:</span> <span class="s">7a219483-6185-11e6-a910-42010a8a0fc0</span>
 <span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">3</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改副本数量为 4 并保存清单文件。</p>

    <p>这个 StatefulSet 现在包含 4 个 pod。</p>
  </li>
  <li>
    <p>获取 Cassandra StatefulSet 来进行验证：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get statefulset cassandra
</code></pre></div>    </div>

    <p>响应应该为：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        DESIRED   CURRENT   AGE
cassandra   4         4         36m
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="cleaning-up">Cleaning up</h2>

<p>删除或缩容 StatefulSet 不会删除与其相关联的 volume。这优先保证了安全性：您的数据比其它所有自动清理的 StatefulSet 资源都更宝贵。</p>

<p class="warning"><strong>警告：</strong> 取决于  storage class 和回收策略（reclaim policy），删除 Persistent Volume Claims 可能导致关联的 volume 也被删除。绝对不要假设在 volume claim 被删除后还能访问数据。</p>

<ol>
  <li>
    <p>运行下面的命令，删除 <code class="highlighter-rouge">StatefulSet</code> 中所有能内容：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grace=$(kubectl get po cassandra-0 -o=jsonpath='{.spec.terminationGracePeriodSeconds}') \
  &amp;&amp; kubectl delete statefulset -l app=cassandra \
  &amp;&amp; echo "Sleeping $grace" \
  &amp;&amp; sleep $grace \
  &amp;&amp; kubectl delete pvc -l app=cassandra
</code></pre></div>    </div>
  </li>
  <li>
    <p>运行下面的命令，删除 Cassandra <code class="highlighter-rouge">Service</code>。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete service -l app=cassandra
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>了解如何  <a href="/docs/tasks/run-application/scale-stateful-set/">扩展 StatefulSet</a>。</li>
  <li>详细了解  <a href="https://github.com/kubernetes/examples/blob/master/cassandra/java/src/main/java/io/k8s/cassandra/KubernetesSeedProvider.java">KubernetesSeedProvider</a>。</li>
  <li>查看更多自定义 <a href="https://git.k8s.io/examples/cassandra/java/README.md">Seed Provider 配置</a>。</li>
</ul>



        <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/tutorials/stateful-application/cassandra.md?pixel" alt="Analytics" /></a></p>
        
	
        <script type="text/javascript">
            PDRTJS_settings_8345992 = {
                "id" : "8345992",
                "unique_id" : "/docs/tutorials/stateful-application/cassandra/",
                "title" : "示例：使用 Stateful Sets 部署 Cassandra",
                "permalink" : "http://kubernetes.github.io/docs/tutorials/stateful-application/cassandra/"
            };
            (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
        </script>
        <a href="" onclick="window.open('https://github.com/kubernetes/kubernetes.github.io/issues/new?title=Issue%20with%20' +
        'k8s.io'+window.location.pathname)" class="button issue">Create an Issue</a>
	
        
          <a href="/editdocs#docs/tutorials/stateful-application/cassandra.md" class="button issue">Edit this Page</a>
        
    
    </div>
</section>

<footer>
    <main class="light-text">
        <nav>
            <a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a>
            <a href="/docs/home/">Documentation</a>
            <a href="http://blog.kubernetes.io/">Blog</a>
            <a href="/partners/">Partners</a>
            <a href="/community/">Community</a>
            <a href="/case-studies/">Case Studies</a>
        </nav>
        <div class="social">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
            <div>
                <a href="/docs/setup/pick-right-solution/" class="button">Get Kubernetes</a>
                <a href="https://github.com/kubernetes/kubernetes" class="button">Contribute</a>
            </div>
        </div>
        <div id="miceType" class="center">
            &copy; 2017 The Kubernetes Authors | Documentation Distributed under <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a>
        </div>
        <div id="miceType" class="center">
            Copyright &copy; 2017 The Linux Foundation&reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our Trademark Usage page: <a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">https://www.linuxfoundation.org/trademark-usage</a>
        </div>
    </main>
</footer>

<button class="flyout-button" onclick="kub.toggleToc()"></button>

<style>
.cse .gsc-control-cse, .gsc-control-cse, {
    padding: 0;
}
  .gsc-control-cse table, .gsc-control-cse-en table {
      margin:0px !important;
  }
  .gsc-above-wrapper-area {
      border-bottom: 0;
  }
</style>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-36037335-10', 'auto');
ga('send', 'pageview');

// hide docs nav area if no nav is present, or if nav only contains a link to the current page
(function () {
    window.addEventListener('DOMContentLoaded', init)

        // play nice with our neighbors
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
            var container = toc.querySelector('.container')

                // container is built dynamically, so it may not be present on the first runloop
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>

<!-- Commenting out AnswerDash for now; we need to work on our list of questions/answers/design first
    <!-- Start of AnswerDash script <script>var AnswerDash;!function(e,t,n,s,a){if(!t.getElementById(s)){var i,r=t.createElement(n),c=t.getElementsByTagName(n)[0];e[a]||(i=e[a]=function(){i.__oninit.push(arguments)},i.__oninit=[]),r.type="text/javascript",r.async=!0,r.src="https://p1.answerdash.com/answerdash.min.js?siteid=756",r.setAttribute("id",s),c.parentNode.insertBefore(r,c)}}(window,document,"script","answerdash-script","AnswerDash");</script> <!-- End of AnswerDash script -->


</body>
</html>
