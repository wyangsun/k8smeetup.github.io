
  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  

  
    
    

  


<!Doctype html>
<html id="docs" class="">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" type="text/css" href="/css/styles.css"><!-- default styles.css on -->
    <link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
    <link rel="stylesheet" type="text/css" href="/css/callouts.css">
    <link rel="stylesheet" type="text/css" href="/css/custom-jekyll/tags.css">
    
    
    <!-- no custom css detected -->

    
    <meta name="description" content="(Deprecated) Using `federation-up` and `deploy.sh`" />
    

    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/sweetalert.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/custom-jekyll/tags.js"></script>
    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>(Deprecated) Using federation-up and deploy.sh | Kubernetes</title>
<meta property="og:title" content="(Deprecated) Using federation-up and deploy.sh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Production-Grade Container Orchestration" />
<meta property="og:description" content="Production-Grade Container Orchestration" />
<link rel="canonical" href="http://0.0.0.0:4000/docs/admin/federation/" />
<meta property="og:url" content="http://0.0.0.0:4000/docs/admin/federation/" />
<meta property="og:site_name" content="Kubernetes" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@kubernetesio" />
<script type="application/ld+json">
{"name":null,"description":"Production-Grade Container Orchestration","author":null,"@type":"WebPage","url":"http://0.0.0.0:4000/docs/admin/federation/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/images/favicon.png"}},"image":null,"headline":"(Deprecated) Using federation-up and deploy.sh","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>

<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/" class="logo"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            <li><a href="/docs/home/">Documentation</a></li>
            <li><a href="http://blog.kubernetes.io/">Blog</a></li>
            <li><a href="/partners/">Partners</a></li>
            <li><a href="/community/">Community</a></li>
            <li><a href="/case-studies/">Case Studies</a></li>
            <li>
                <a href="#">
                    v1.8 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                  <li><a href="https://kubernetes.io/docs/home/">v1.8</a></li>
                
                  <li><a href="https://v1-7.docs.kubernetes.io/docs/home/">v1.7</a></li>
                
                  <li><a href="https://v1-6.docs.kubernetes.io/docs/home/">v1.6</a></li>
                
                  <li><a href="https://v1-5.docs.kubernetes.io/docs/">v1.5</a></li>
                
                  <li><a href="https://v1-4.docs.kubernetes.io/docs/">v1.4</a></li>
                
                </ul>
              </li>
            </li>
        </ul>
        <!-- <a href="/docs/home" class="button" id="viewDocs" data-auto-burger-exclude>View Documentation</a> -->
        <a href="/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>Try Kubernetes</a>
        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <main data-auto-burger="primary">
        <div class="nav-box">
            <h3><a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a></h3>
            <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>
        </div>
        <div class="nav-box">
            <h3><a href="/docs/home/">Documentation</a></h3>
            <p>Learn how to use Kubernetes with the use of walkthroughs, samples, and reference documentation. You can even <a href="/editdocs/" data-auto-burger-exclude>help contribute to the docs</a>!</p>
        </div>
        <div class="nav-box">
            <h3><a href="/community/">Community</a></h3>
            <p>If you need help, you can connect with other Kubernetes users and the Kubernetes authors, attend community events, and watch video presentations from around the web.</p>
        </div>
        <div class="nav-box">
            <h3><a href="http://blog.kubernetes.io">Blog</a></h3>
            <p>Read the latest news for Kubernetes and the containers space in general, and get technical how-tos hot off the presses.</p>
        </div>
        </main>
        <main data-auto-burger="primary">
        <div class="left">
            <h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
            <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>View On Github</a>
        </div>

        <div class="right">
            <h5 class="github-invite">Explore the community</h5>
            <div class="social">
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
        </div>
        <div class="clear" style="clear: both"></div>
        </main>
    </nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
  <h1></h1>
  <h5></h5>
  <div id="vendorStrip" class="light-text">
    <ul>
      <li><a href="/docs/home/" >HOME</a></li>
      <li><a href="/docs/setup/" >SETUP</a></li>
      <li><a href="/docs/concepts/" >CONCEPTS</a></li>
      <li><a href="/docs/tasks/" >TASKS</a></li>
      <li><a href="/docs/tutorials/" >TUTORIALS</a></li>
      <li><a href="/docs/reference/" >REFERENCE</a></li>
    </ul>
    <div id="searchBox">
      <input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)" autofocus="autofocus">
    </div>
  </div>
</section>




<section id="encyclopedia">
  <div id="docsToc">
        <div class="pi-accordion">
          
  

    

    
      <a class="item" data-title="Search Results" href="/docs/search/"></a>
    
  


        </div> <!-- /pi-accordion -->
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
  </div> <!-- /docsToc -->

  <div id="docsContent">
        <p><a href="/editdocs#docs/admin/federation/index.md" id="editPageButton">Edit This Page</a></p>

        
          <h1>(Deprecated) Using `federation-up` and `deploy.sh`</h1>
        

        <h2 id="the-mechanisms-explained-in-this-doc-to-setup-federation-are-deprecated-kubefed-is-now-the-recommended-way-to-deploy-federation">The mechanisms explained in this doc to setup federation are deprecated. <a href="/docs/tasks/federation/set-up-cluster-federation-kubefed/"><code class="highlighter-rouge">kubefed</code></a> is now the recommended way to deploy federation.</h2>

<p>This guide explains how to set up cluster federation that lets us control multiple Kubernetes clusters.</p>

<ul id="markdown-toc">
  <li><a href="#the-mechanisms-explained-in-this-doc-to-setup-federation-are-deprecated-kubefed-is-now-the-recommended-way-to-deploy-federation" id="markdown-toc-the-mechanisms-explained-in-this-doc-to-setup-federation-are-deprecated-kubefed-is-now-the-recommended-way-to-deploy-federation">The mechanisms explained in this doc to setup federation are deprecated. <code class="highlighter-rouge">kubefed</code> is now the recommended way to deploy federation.</a></li>
  <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li>
  <li><a href="#setting-up-a-federation-control-plane" id="markdown-toc-setting-up-a-federation-control-plane">Setting up a federation control plane</a>    <ul>
      <li><a href="#initial-setup" id="markdown-toc-initial-setup">Initial setup</a></li>
      <li><a href="#getting-images" id="markdown-toc-getting-images">Getting images</a></li>
      <li><a href="#using-official-release-images" id="markdown-toc-using-official-release-images">Using official release images</a></li>
      <li><a href="#building-and-pushing-images-from-head" id="markdown-toc-building-and-pushing-images-from-head">Building and pushing images from HEAD</a></li>
      <li><a href="#running-the-federation-control-plane" id="markdown-toc-running-the-federation-control-plane">Running the federation control plane</a></li>
    </ul>
  </li>
  <li><a href="#registering-kubernetes-clusters-with-federation" id="markdown-toc-registering-kubernetes-clusters-with-federation">Registering Kubernetes clusters with federation</a></li>
  <li><a href="#updating-kubedns" id="markdown-toc-updating-kubedns">Updating KubeDNS</a>    <ul>
      <li><a href="#kubernetes-15-passing-federations-flag-via-config-map-to-kube-dns" id="markdown-toc-kubernetes-15-passing-federations-flag-via-config-map-to-kube-dns">Kubernetes 1.5+: Passing federations flag via config map to kube-dns</a></li>
      <li><a href="#kubernetes-14-and-earlier-setting-federations-flag-on-kube-dns-rc" id="markdown-toc-kubernetes-14-and-earlier-setting-federations-flag-on-kube-dns-rc">Kubernetes 1.4 and earlier: Setting federations flag on kube-dns-rc</a></li>
    </ul>
  </li>
  <li><a href="#turn-down" id="markdown-toc-turn-down">Turn down</a></li>
  <li><a href="#previous-federation-turn-up-mechanism" id="markdown-toc-previous-federation-turn-up-mechanism">Previous Federation turn up mechanism</a>    <ul>
      <li><a href="#getting-images-1" id="markdown-toc-getting-images-1">Getting images</a>        <ul>
          <li><a href="#using-official-release-images-1" id="markdown-toc-using-official-release-images-1">Using official release images</a></li>
          <li><a href="#building-and-pushing-images-from-head-1" id="markdown-toc-building-and-pushing-images-from-head-1">Building and pushing images from HEAD</a></li>
        </ul>
      </li>
      <li><a href="#running-the-federation-control-plane-1" id="markdown-toc-running-the-federation-control-plane-1">Running the federation control plane</a></li>
    </ul>
  </li>
  <li><a href="#for-more-information" id="markdown-toc-for-more-information">For more information</a></li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<p>This guide assumes that you have a running Kubernetes cluster.
If you need to start a new cluster, see the <a href="/docs/setup/">getting started guides</a> for instructions on bringing a cluster up.</p>

<p>To use the commands in this guide, you must download a Kubernetes release from the 
<a href="/docs/getting-started-guides/binary_release/">getting started binary releases</a> and 
extract into a directory; all the commands in this guide are run from
that directory.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-L</span> https://github.com/kubernetes/kubernetes/releases/download/v1.4.0/kubernetes.tar.gz | <span class="nb">tar </span>xvzf -
<span class="nv">$ </span><span class="nb">cd </span>kubernetes
</code></pre></div></div>

<p>You must also have a Docker installation running
locally–meaning on the machine where you run the commands described in this
guide.</p>

<h2 id="setting-up-a-federation-control-plane">Setting up a federation control plane</h2>

<p>Setting up federation requires running the federation control plane which
consists of etcd, federation-apiserver (via the hyperkube binary) and
federation-controller-manager (also via the hyperkube binary). You can run
these binaries as pods on an existing Kubernetes cluster.</p>

<p>Note: This is a new mechanism to turn up Kubernetes Cluster Federation. If
you want to follow the old mechanism, please refer to the section
<a href="#previous-federation-turn-up-mechanism">Previous Federation turn up mechanism</a>
at the end of this guide.</p>

<h3 id="initial-setup">Initial setup</h3>

<p>Create a directory to store the configs required to turn up federation
and export that directory path in the environment variable
<code class="highlighter-rouge">FEDERATION_OUTPUT_ROOT</code>. This can be an existing directory, but it is
highly recommended to create a separate directory so that it is easier
to clean up later.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">FEDERATION_OUTPUT_ROOT</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span><span class="s2">/_output/federation"</span>
<span class="nv">$ </span>mkdir <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">FEDERATION_OUTPUT_ROOT</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>Initialize the setup.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>federation/deploy/deploy.sh init
</code></pre></div></div>

<p>Optionally, you can create/edit <code class="highlighter-rouge">${FEDERATION_OUTPUT_ROOT}/values.yaml</code> to
customize any value in
<a href="https://github.com/madhusudancs/kubernetes-anywhere/blob/federation/federation/manifests/federation/values.yaml">federation/federation/manifests/federation/values.yaml</a>. Example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiserverRegistry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">gcr.io/myrepository"</span>
<span class="na">apiserverVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v1.5.0-alpha.0.1010+892a6d7af59c0b"</span>
<span class="na">controllerManagerRegistry</span><span class="pi">:</span> <span class="s2">"</span><span class="s">gcr.io/myrepository"</span>
<span class="na">controllerManagerVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v1.5.0-alpha.0.1010+892a6d7af59c0b"</span>
</code></pre></div></div>

<p>Assuming you have built and pushed the <code class="highlighter-rouge">hyperkube</code> image to the repository
with the given tag in the example above.</p>

<h3 id="getting-images">Getting images</h3>

<p>To run the federation control plane components as pods, you first need the
images for all the components. You can either use the official release
images or you can build them yourself from HEAD.</p>

<h3 id="using-official-release-images">Using official release images</h3>

<p>As part of every Kubernetes release, official release images are pushed to
<code class="highlighter-rouge">gcr.io/google_containers</code>. To use the images in this repository, you can
set the container image fields in the following configs to point to the
images in this repository. <code class="highlighter-rouge">gcr.io/google_containers/hyperkube</code> image
includes the federation-apiserver and federation-controller-manager
binaries, so you can point the corresponding configs for those components
to the hyperkube image.</p>

<h3 id="building-and-pushing-images-from-head">Building and pushing images from HEAD</h3>

<p>To build the binaries, check out the
<a href="https://github.com/kubernetes/kubernetes">Kubernetes repository</a> and
run the following commands from the root of the source directory:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>federation/develop/develop.sh build_binaries
</code></pre></div></div>

<p>To build the image and push it to the repository, run:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ KUBE_REGISTRY</span><span class="o">=</span><span class="s2">"gcr.io/myrepository"</span> federation/develop/develop.sh build_image
<span class="nv">$ KUBE_REGISTRY</span><span class="o">=</span><span class="s2">"gcr.io/myrepository"</span> federation/develop/develop.sh push
</code></pre></div></div>

<p>Note: This is going to overwrite the values you might have set for
<code class="highlighter-rouge">apiserverRegistry</code>, <code class="highlighter-rouge">apiserverVersion</code>, <code class="highlighter-rouge">controllerManagerRegistry</code> and
<code class="highlighter-rouge">controllerManagerVersion</code> in your <code class="highlighter-rouge">${FEDERATION_OUTPUT_ROOT}/values.yaml</code>
file. Hence, it is not recommend to customize these values in
<code class="highlighter-rouge">${FEDERATION_OUTPUT_ROOT}/values.yaml</code> if you are building the
images from source.</p>

<h3 id="running-the-federation-control-plane">Running the federation control plane</h3>

<p>Once you have the images, you can turn up the federation control plane by
running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>federation/deploy/deploy.sh deploy_federation
</code></pre></div></div>

<p>This spins up the federation control components as pods managed by
<a href="/docs/concepts/workloads/controllers/deployment/"><code class="highlighter-rouge">Deployments</code></a> on your
existing Kubernetes cluster. It also starts a
<a href="/docs/concepts/services-networking/service/#type-loadbalancer"><code class="highlighter-rouge">type: LoadBalancer</code></a>
<a href="/docs/concepts/services-networking/service/"><code class="highlighter-rouge">Service</code></a> for the
<code class="highlighter-rouge">federation-apiserver</code> and a
<a href="/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims/"><code class="highlighter-rouge">PVC</code></a> backed
by a dynamically provisioned
<a href="/docs/concepts/storage/persistent-volumes/"><code class="highlighter-rouge">PV</code></a> for
 <code class="highlighter-rouge">etcd</code>. All these components are created in the <code class="highlighter-rouge">federation</code> namespace.</p>

<p>You can verify that the pods are available by running the following
command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deployments <span class="nt">--namespace</span><span class="o">=</span>federation
NAME                            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
federation-apiserver            1         1         1            1           1m
federation-controller-manager   1         1         1            1           1m
</code></pre></div></div>

<p>Running <code class="highlighter-rouge">deploy.sh</code> also creates a new record in your kubeconfig for us
to be able to talk to federation apiserver. You can view this by running
<code class="highlighter-rouge">kubectl config view</code>.</p>

<p>Note: Dynamic provisioning for persistent volume currently works only on
AWS, Google Kubernetes Engine, and GCE. However, you can edit the created <code class="highlighter-rouge">Deployments</code> to suit
your needs, if required.</p>

<h2 id="registering-kubernetes-clusters-with-federation">Registering Kubernetes clusters with federation</h2>

<p>Now that you have the federation control plane up and running, you can start registering Kubernetes clusters.</p>

<p>First of all, you need to create a secret containing kubeconfig for that Kubernetes cluster, which federation control plane will use to talk to that Kubernetes cluster.
For now, you can create this secret in the host Kubernetes cluster (that hosts federation control plane). When federation starts supporting secrets, you will be able to create this secret there.
Suppose that your kubeconfig for Kubernetes cluster is at <code class="highlighter-rouge">/cluster1/kubeconfig</code>, you can run the following command to create the secret:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create secret generic cluster1 <span class="nt">--namespace</span><span class="o">=</span>federation <span class="nt">--from-file</span><span class="o">=</span>/cluster1/kubeconfig
</code></pre></div></div>

<p>Note that the file name should be <code class="highlighter-rouge">kubeconfig</code> since file name determines the name of the key in the secret.</p>

<p>Now that the secret is created, you are ready to register the cluster. The YAML file for cluster will look like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">federation/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Cluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serverAddressByClientCIDRs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">clientCIDR</span><span class="pi">:</span> <span class="s">&lt;client-cidr&gt;</span>
    <span class="na">serverAddress</span><span class="pi">:</span> <span class="s">&lt;apiserver-address&gt;</span>
  <span class="na">secretRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">&lt;secret-name&gt;</span>
</code></pre></div></div>

<p>You need to insert the appropriate values for <code class="highlighter-rouge">&lt;client-cidr&gt;</code>, <code class="highlighter-rouge">&lt;apiserver-address&gt;</code> and <code class="highlighter-rouge">&lt;secret-name&gt;</code>.
<code class="highlighter-rouge">&lt;secret-name&gt;</code> here is name of the secret that you just created.
serverAddressByClientCIDRs contains the various server addresses that clients
can use as per their CIDR. You can set the server’s public IP address with CIDR
<code class="highlighter-rouge">"0.0.0.0/0"</code> which all clients will match. In addition, if you want internal
clients to use server’s clusterIP, you can set that as serverAddress. The client
CIDR in that case will be a CIDR that only matches IPs of pods running in that
cluster.</p>

<p>Assuming your YAML file is located at <code class="highlighter-rouge">/cluster1/cluster.yaml</code>, you can run the following command to register this cluster:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> /cluster1/cluster.yaml <span class="nt">--context</span><span class="o">=</span>federation-cluster

</code></pre></div></div>

<p>By specifying <code class="highlighter-rouge">--context=federation-cluster</code>, you direct the request to
federation apiserver. You can ensure that the cluster registration was
successful by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get clusters <span class="nt">--context</span><span class="o">=</span>federation-cluster
NAME       STATUS    VERSION   AGE
cluster1   Ready               3m
</code></pre></div></div>

<h2 id="updating-kubedns">Updating KubeDNS</h2>

<p>Once you’ve registered your cluster with the federation, you’ll need to update KubeDNS so that your cluster can route federation service requests. The update method varies depending on your Kubernetes version; on Kubernetes 1.5 or later, you must pass the
<code class="highlighter-rouge">--federations</code> flag to kube-dns via the kube-dns config map. In version 1.4 or earlier, you must set the <code class="highlighter-rouge">--federations</code> flag directly on kube-dns-rc on other clusters.</p>

<h3 id="kubernetes-15-passing-federations-flag-via-config-map-to-kube-dns">Kubernetes 1.5+: Passing federations flag via config map to kube-dns</h3>

<p>For Kubernetes clusters of version 1.5+, you can pass the
<code class="highlighter-rouge">--federations</code> flag to kube-dns via the kube-dns config map.
The flag uses the following format:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--federations=${FEDERATION_NAME}=${DNS_DOMAIN_NAME}
</code></pre></div></div>

<p>To pass this flag to KubeDNS, create a config-map with name <code class="highlighter-rouge">kube-dns</code> in
namespace <code class="highlighter-rouge">kube-system</code>. The configmap should look like the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">federations</span><span class="pi">:</span> <span class="s">&lt;federation-name&gt;=&lt;federation-domain-name&gt;</span>
</code></pre></div></div>

<p>where <code class="highlighter-rouge">&lt;federation-name&gt;</code> should be replaced by the name you want to give to your
federation, and
<code class="highlighter-rouge">federation-domain-name</code> should be replaced by the domain name you want to use
in your federation DNS.</p>

<p>You can find more details about config maps in general at
<a href="/docs/tasks/configure-pod-container/configmap/">config map</a>.</p>

<h3 id="kubernetes-14-and-earlier-setting-federations-flag-on-kube-dns-rc">Kubernetes 1.4 and earlier: Setting federations flag on kube-dns-rc</h3>

<p>If your cluster is running Kubernetes version 1.4 or earlier, you must restart
KubeDNS and pass it a <code class="highlighter-rouge">--federations</code> flag, which tells it about valid federation DNS hostnames.
The flag uses the following format:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--federations=${FEDERATION_NAME}=${DNS_DOMAIN_NAME}
</code></pre></div></div>

<p>To update KubeDNS with the <code class="highlighter-rouge">--federations</code> flag, you can edit the existing kubedns replication controller to
include that flag in pod template spec, and then delete the existing pod. The replication controller then
recreates the pod with updated template.</p>

<p>To find the name of existing kubedns replication controller, run the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get rc <span class="nt">--namespace</span><span class="o">=</span>kube-system
</code></pre></div></div>

<p>You should see a list of all the replication controllers on the cluster. The kube-dns replication
controller should have a name similar to <code class="highlighter-rouge">kube-dns-v18</code>. To edit the replication controller, specify it by name as follows:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl edit rc &lt;rc-name&gt; <span class="nt">--namespace</span><span class="o">=</span>kube-system
</code></pre></div></div>
<p>In the resulting YAML file for the kube-dns replication controller, add the <code class="highlighter-rouge">--federations</code> flag as an argument to kube-dns container.</p>

<p>Then, you must delete the existing kube dns pod. You can find the pod by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">--namespace</span><span class="o">=</span>kube-system
</code></pre></div></div>

<p>And then delete the appropriate pod by running:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete pods &lt;pod-name&gt; <span class="nt">--namespace</span><span class="o">=</span>kube-system
</code></pre></div></div>

<p>Once you’ve completed the kube-dns configuration, your federation is ready for use.</p>

<h2 id="turn-down">Turn down</h2>

<p>In order to turn the federation control plane down run the following
command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>federation/deploy/deploy.sh destroy_federation
</code></pre></div></div>

<h2 id="previous-federation-turn-up-mechanism">Previous Federation turn up mechanism</h2>

<p>This describes the previous mechanism we had to turn up Kubernetes Cluster
Federation. It is recommended to use the new turn up mechanism. If you would
like to use this mechanism instead of the new one, please let us know
why the new mechanism doesn’t work for your case by filing an issue here -
<a href="https://github.com/kubernetes/kubernetes/issues/new">https://github.com/kubernetes/kubernetes/issues/new</a></p>

<h3 id="getting-images-1">Getting images</h3>

<p>To run these as pods, you first need images for all the components. You can use
official release images or you can build from HEAD.</p>

<h4 id="using-official-release-images-1">Using official release images</h4>

<p>As part of every release, images are pushed to <code class="highlighter-rouge">gcr.io/google_containers</code>. To use
these images, set env var <code class="highlighter-rouge">FEDERATION_PUSH_REPO_BASE=gcr.io/google_containers</code>
This will always use the latest image.
To use the hyperkube image which includes federation-apiserver and
federation-controller-manager from a specific release, set the
<code class="highlighter-rouge">FEDERATION_IMAGE_TAG</code> environment variable.</p>

<h4 id="building-and-pushing-images-from-head-1">Building and pushing images from HEAD</h4>

<p>To run the code from HEAD, you need to build and push your own images.
You can build the images using the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ FEDERATION</span><span class="o">=</span><span class="nb">true </span><span class="nv">KUBE_RELEASE_RUN_TESTS</span><span class="o">=</span>n make quick-release
</code></pre></div></div>

<p>Next, you need to push these images to a registry such as Google Container Registry or Docker Hub, so that your cluster can pull them.
If Kubernetes cluster is running on Google Compute Engine (GCE), then you can push the images to <code class="highlighter-rouge">gcr.io/&lt;gce-project-name&gt;</code>.
The command to push the images will look like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ FEDERATION</span><span class="o">=</span><span class="nb">true </span><span class="nv">FEDERATION_PUSH_REPO_BASE</span><span class="o">=</span>gcr.io/&lt;gce-project-name&gt; ./build/push-federation-images.sh
</code></pre></div></div>

<h3 id="running-the-federation-control-plane-1">Running the federation control plane</h3>

<p>Once you have the images, you can run these as pods on your existing kubernetes cluster.
The command to run these pods on an existing GCE cluster will look like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ KUBERNETES_PROVIDER</span><span class="o">=</span>gce <span class="nv">FEDERATION_DNS_PROVIDER</span><span class="o">=</span>google-clouddns <span class="nv">FEDERATION_NAME</span><span class="o">=</span>myfederation <span class="nv">DNS_ZONE_NAME</span><span class="o">=</span>myfederation.example <span class="nv">FEDERATION_PUSH_REPO_BASE</span><span class="o">=</span>gcr.io/google_containers ./federation/cluster/federation-up.sh
</code></pre></div></div>

<p><code class="highlighter-rouge">KUBERNETES_PROVIDER</code> is the cloud provider.</p>

<p><code class="highlighter-rouge">FEDERATION_DNS_PROVIDER</code> can be <code class="highlighter-rouge">google-clouddns</code> or <code class="highlighter-rouge">aws-route53</code>. It will be
set appropriately if it is missing and <code class="highlighter-rouge">KUBERNETES_PROVIDER</code> is one of <code class="highlighter-rouge">gce</code>, <code class="highlighter-rouge">gke</code> and <code class="highlighter-rouge">aws</code>.
This is used to resolve DNS requests for federation services. The service
controller keeps DNS records with the provider updated as services/pods are
updated in underlying Kubernetes clusters.</p>

<p><code class="highlighter-rouge">FEDERATION_NAME</code> is a name you can choose for your federation. This is the name that will appear in DNS routes.</p>

<p><code class="highlighter-rouge">DNS_ZONE_NAME</code> is the domain to be used for DNS records. This is a domain that you
need to buy and then configure it such that DNS queries for that domain are
routed to the appropriate provider as per <code class="highlighter-rouge">FEDERATION_DNS_PROVIDER</code>.</p>

<p>Running that command creates a namespace <code class="highlighter-rouge">federation</code> and creates 2 deployments: <code class="highlighter-rouge">federation-apiserver</code> and <code class="highlighter-rouge">federation-controller-manager</code>.
You can verify that the pods are available by running the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deployments <span class="nt">--namespace</span><span class="o">=</span>federation
NAME                            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
federation-apiserver            1         1         1            1           1m
federation-controller-manager   1         1         1            1           1m
</code></pre></div></div>

<p>Running <code class="highlighter-rouge">federation-up.sh</code> also creates a new record in your kubeconfig for us
to be able to talk to federation apiserver. You can view this by running
<code class="highlighter-rouge">kubectl config view</code>.</p>

<p>Note: <code class="highlighter-rouge">federation-up.sh</code> creates the federation-apiserver pod with an etcd
container that is backed by a persistent volume, so as to persist data. This
currently works only on AWS, Google Kubernetes Engine, and GCE.  You can edit
<code class="highlighter-rouge">federation/manifests/federation-apiserver-deployment.yaml</code> to suit your needs,
if required.</p>

<h2 id="for-more-information">For more information</h2>

<ul>
  <li><a href="https://git.k8s.io/community/contributors/design-proposals/multicluster/federation.md">Federation proposal</a> details use cases that motivated this work.</li>
</ul>


        <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/admin/federation/index.md?pixel" alt="Analytics" /></a></p>
        
	
        <script type="text/javascript">
            PDRTJS_settings_8345992 = {
                "id" : "8345992",
                "unique_id" : "/docs/admin/federation/",
                "title" : "(Deprecated) Using `federation-up` and `deploy.sh`",
                "permalink" : "http://kubernetes.github.io/docs/admin/federation/"
            };
            (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
        </script>
        <a href="" onclick="window.open('https://github.com/kubernetes/kubernetes.github.io/issues/new?title=Issue%20with%20' +
        'k8s.io'+window.location.pathname)" class="button issue">Create an Issue</a>
	
        
          <a href="/editdocs#docs/admin/federation/index.md" class="button issue">Edit this Page</a>
        
    
    </div>
</section>

<footer>
    <main class="light-text">
        <nav>
            <a href="/docs/tutorials/stateless-application/hello-minikube/">Get Started</a>
            <a href="/docs/home/">Documentation</a>
            <a href="http://blog.kubernetes.io/">Blog</a>
            <a href="/partners/">Partners</a>
            <a href="/community/">Community</a>
            <a href="/case-studies/">Case Studies</a>
        </nav>
        <div class="social">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
                <a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://groups.google.com/forum/#!forum/kubernetes-users" class="mailing-list"><span>Mailing List</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
            <div>
                <a href="/docs/setup/pick-right-solution/" class="button">Get Kubernetes</a>
                <a href="https://github.com/kubernetes/kubernetes" class="button">Contribute</a>
            </div>
        </div>
        <div id="miceType" class="center">
            &copy; 2017 The Kubernetes Authors | Documentation Distributed under <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a>
        </div>
        <div id="miceType" class="center">
            Copyright &copy; 2017 The Linux Foundation&reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our Trademark Usage page: <a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">https://www.linuxfoundation.org/trademark-usage</a>
        </div>
    </main>
</footer>

<button class="flyout-button" onclick="kub.toggleToc()"></button>

<style>
.cse .gsc-control-cse, .gsc-control-cse, {
    padding: 0;
}
  .gsc-control-cse table, .gsc-control-cse-en table {
      margin:0px !important;
  }
  .gsc-above-wrapper-area {
      border-bottom: 0;
  }
</style>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-36037335-10', 'auto');
ga('send', 'pageview');

// hide docs nav area if no nav is present, or if nav only contains a link to the current page
(function () {
    window.addEventListener('DOMContentLoaded', init)

        // play nice with our neighbors
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
            var container = toc.querySelector('.container')

                // container is built dynamically, so it may not be present on the first runloop
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>

<!-- Commenting out AnswerDash for now; we need to work on our list of questions/answers/design first
    <!-- Start of AnswerDash script <script>var AnswerDash;!function(e,t,n,s,a){if(!t.getElementById(s)){var i,r=t.createElement(n),c=t.getElementsByTagName(n)[0];e[a]||(i=e[a]=function(){i.__oninit.push(arguments)},i.__oninit=[]),r.type="text/javascript",r.async=!0,r.src="https://p1.answerdash.com/answerdash.min.js?siteid=756",r.setAttribute("id",s),c.parentNode.insertBefore(r,c)}}(window,document,"script","answerdash-script","AnswerDash");</script> <!-- End of AnswerDash script -->


</body>
</html>
